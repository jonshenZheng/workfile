<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>index</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="cache-control" content="no-cache">
	<meta http-equiv="expires" content="0">
	<link th:href="@{/common/bootstrap-3.3.7-dist/css/bootstrap.min.css}" rel="stylesheet">
	<link rel="stylesheet" th:href="@{/common/lib/dialog/bootstrap-dialog.min.css}"/>
	<link th:href="@{/common/css/console.css}" rel="stylesheet">
	<link th:href="@{/common/css/iframhome.css}" rel="stylesheet">
	<!--[if lt IE 9]>
	<script src="https://cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
	<script th:src="@{/common/js/respond.min.js}"></script>
	<![endif]-->
	<!-- Bootstrap end-->
	<link rel="stylesheet" th:href="@{/common/css/prodLib_slectArea.css}"/>
	<link rel="stylesheet" th:href="@{/common/lib/swiper/swiper.min.css}"/>
	<link th:href="@{/common/css/bootstrap-treeview.css}" rel="stylesheet">
	<link rel="stylesheet" th:href="@{/common/css/font-awesome.min.css}"/>
	<link rel="stylesheet" th:href="@{/common/css/build.css}"/>
	<link rel="stylesheet" th:href="@{/common/lib/jquery-lightbox-0.5/css/jquery.lightbox-0.5.css}"/>
	<link rel="stylesheet" th:href="@{/common/css/prodLib.css}"/>


</head>
<body style="background-color:transparent;width: 100%;overflow-x: auto">
<input type="hidden" th:value="@{/}" id="projPath"/>


<input type="hidden" name="filepath" th:value="${filepath}"/>

<div class="container position-r prodLibheiBox">
	<!--样式那边改了，提交要更新这个节点  两个项目4个模板都得改-->
	<div class="left_mune_line" style="position: absolute;left: 160px;height: 950px;width: 0;border-right: 1px solid #ddd;"></div>
	<!--样式那边改了，提交要更新这个节点 两个项目4个模板都得改-->

	<!--测试节点-->
	<div id="test-el" style="text-align: center;font-size: 20px"></div>
	<!--测试节点 end-->

	<div class="pdLibTop">产品库<a class="closeBtn" onclick="prodlib_closeBtn();">关闭</a></div>
	<div class="row" style="min-height:820px">

		<div style="width: initial;float:left" class="leftMune">
			<div class="leftMuneScroll">
				<div class="justMask" id="justMask"></div>
				<div id="prodTypeListDiv" style="height:100%;overflow-y:auto;">

					<li class="count0 level0"><a class="list-group-item node-prodTypeListDiv active level1 tree-dropdown-toggle-js" data-fid="all" data-path="" data-depath="0">全部产品</a></li>
					<li th:each="product,productStat: ${nodes}" th:class="'count'+${productStat.count+' level0'}">
						<div th:if="${#lists.size(product.nodes)} gt 0">
							<a th:if="${productStat.count} eq 0" class="list-group-item node-prodTypeListDiv active level1 tree-dropdown-toggle-js" th:data-fid="${product.fid}" th:data-path="${product.path}" data-depath="0"><i class="icon expand-icon glyphicon-plus"></i><span class="treeNmae-js" th:text="${product.text}"></span><span class="nav_tri"></span></a>
							<a th:if="${productStat.count} ne 0" class="list-group-item node-prodTypeListDiv level1 tree-dropdown-toggle-js" th:data-fid="${product.fid}" th:data-path="${product.path}" data-depath="0"><i class="icon expand-icon glyphicon-plus"></i><span class="treeNmae-js" th:text="${product.text}"></span><span class="nav_tri"></span></a>
							<ul class="submenu">
								<li class="'count'+${productStat.count+' level2'}" th:each="child : ${product.nodes}">
									<a class="list-group-item node-prodTypeListDiv level2 tree-dropdown-toggle-js" th:data-fid="${child.fid}" th:data-path="${child.path}" data-depath="1" ><span class="treeNmae-js" th:text="${child.text}"></span></a>
								</li>
							</ul>
						</div>
						<div th:if="${#lists.size(product.nodes)} eq 0">
							<a th:if="${productStat.count} eq 0" class="list-group-item node-prodTypeListDiv active level1 tree-dropdown-toggle-js" th:data-fid="${product.fid}" th:data-path="${product.path}" th:data-depath="0" ><span class="treeNmae-js" th:text="${product.text}"></span></a>
							<a th:if="${productStat.count} ne 0" class="list-group-item node-prodTypeListDiv level1 tree-dropdown-toggle-js" th:data-fid="${product.fid}" th:data-path="${product.fid}" data-depath="0" ><span class="treeNmae-js" th:text="${product.text}"></span></a>
						</div>
					</li>

				</div>
			</div>

		</div>

		<div style="margin-left:160px;overflow:hidden;" id="prodRightBox">

			<div class="addScrollDiv04-13">
				<div class="" style="margin: 0 0 10px 0;">
					<div class="prodlibTil">
						产品类别：
						<span class="til" id="prodlibTilName">全部产品</span>
					</div>
                    <div class="filterlistBoxWrap" id="filterlistBoxWrap">
                        <div id="filterlistBox" class="filterlistBox clearfix"></div>
                        <div class="fliterBtn">
                            <a class="reset_btn" onclick="resetFilterlistBoxFn()">重置</a>
                            <!--<a class="reset_btn" onclick="removeSelectArea(true)">重置</a>-->
                            <a class="filter_btn" onclick="multyChoose();">筛选</a>
                        </div>
                    </div>

					<div id="filterlist" class="filterlist04-13"></div>
					<div class="topMune clearfix">
						<div class="topWp">
							<div class="fl searechFrom clearfix">
								<span class="pdNameLabel">产品名称：</span>
								<form action="" class="fl">
									<p class="inpWp">
										<input type="text" id="produceName"/>
										<a id="sereachBtn">搜索</a>
									</p>
								</form>
								<a class="prodBySort"><span>价格</span><i></i></a>
								<a class="prodBySort"><span>尺寸</span><i></i></a>
								<a class="filterBtn" id="filterBtn">更多选项 ▽</a>
							</div>
						</div>
						<div class="filterBox" id="filterBox">
							<div class="scrollBox">
								<div class="filterlist">
									<div class="fitem clearfix">
										<p class="til">规格：</p>
										<div class="opt" id="insertinput">
											<span id="insertinput_defult">
												<input type="text" class="" placeholder="长度" id="width" onblur="setIntNumber(this,true)" onkeyup="setIntNumber(this)" onafterpaste="setIntNumber(this)"/>
												<span class="line">——</span>
												<input type="text" class="" placeholder="宽度" id="depth" onblur="setIntNumber(this,true)" onkeyup="setIntNumber(this)" onafterpaste="setIntNumber(this)"/>
												<span class="line">——</span>
												<input type="text" class="" placeholder="高度" id="heigth" onblur="setIntNumber(this,true)" onkeyup="setIntNumber(this)" onafterpaste="setIntNumber(this)" />
												<span class="unit">mm</span> 
											</span>	
											<span id="insertinput_act" style="display:none">
												<span class="fg"> <span class="fg_name">长度</span> <input type="text" class="" onblur="setIntNumber(this,true)" onkeyup="setIntNumber(this)" onafterpaste="setIntNumber(this)"  id="width_l"/> <span class="line">——</span> <input type="text" class="" onblur="setIntNumber(this,true)" onkeyup="setIntNumber(this)" onafterpaste="setIntNumber(this)" id="width_u"/> <span class="unit">mm</span> </span> <span class="fg"> <span class="fg_name">宽度</span> <input type="text" class="" onblur="setIntNumber(this,true)" onkeyup="setIntNumber(this)" onafterpaste="setIntNumber(this)" id="depth_l"/> <span class="line">——</span> <input type="text" class="" onblur="setIntNumber(this,true)" onkeyup="setIntNumber(this)" onafterpaste="setIntNumber(this)" id="depth_u"/> <span class="unit">mm</span> </span> <span class="fg"> <span class="fg_name">高度</span> <input type="text" class="" onblur="setIntNumber(this,true)" onkeyup="setIntNumber(this)" onafterpaste="setIntNumber(this)" id="height_l"/> <span class="line">——</span> <input type="text" class="" onblur="setIntNumber(this,true)" onkeyup="setIntNumber(this)" onafterpaste="setIntNumber(this)" id="height_u"/> <span class="unit">mm</span> </span>',
											</span>	
										
										</div>
										<a class="switchInputBtn" id="switchInputBtn" onclick="switchInput(this)">精确筛选</a>
									</div>
									<div class="fitem clearfix">
										<p class="til">成本：</p>
										<div class="opt">
											<input type="text" class="" onblur="setIntNumber(this,true)" onkeyup="setIntNumber(this)" onafterpaste="setIntNumber(this)" placeholder="最低价" id="minMoney"/>
											<span class="line">——</span>
											<input type="text" class="" onblur="setIntNumber(this,true)" onkeyup="setIntNumber(this)" onafterpaste="setIntNumber(this)" placeholder="最高价" id="maxMoney"/>
										</div>
									</div>
									<!--<div class="fitem clearfix">
										<p class="til">厂商：</p>
										<div class="opt">
											<select class="fatorySelect"  name="" id="factoryName"></select>
										</div>
									</div>-->
									<!-- <div id="filterlist"></div>-->

								</div>
							</div>
							<div class="btnBox">
								<a class="cancle" id="filterCancle_plod">重置</a>
								<a class="subBtn" id="filterSubBtn_plod">筛选</a>
							</div>
						</div>
					</div>
				</div>
				<input type="hidden" name="areaId" id="areaId">
				<input type="hidden" name="offerId" id="offerId">
				<input type="hidden" id="prodTypeId" name="proTypeId">
				<input type="hidden" id="fingerprint">

				<!-- 用变量来写-->
				<input type="hidden" id="buyRate_yf" value="0.30">
				<input type="hidden" id="buyRate_ywAcFn4RWqkV9fqbtn2Q" value="0.50">
				<th:each items="compAuth:${user.compDealerAuths}">
					<input type="hidden" id="buyRate_${compAuth.company}" value="${compAuth.buyRate}"/>
				</th:each>
				<!-- 用变量来写-->

				<div class="clearfix prodlibImgtabBox prodlibImgtabBox2018">
					<div class="popBg" id="filterBg" style="z-index:1;display:none"></div>
					<div style="overflow-x:auto;overflow-y:hidden">
						<table id="prodPicTable" style="border:none;width:100%;table-layout:fixed" >
							<tbody></tbody>
						</table>
					</div>
				</div>

			</div>

			<div class="pagingBox">
				<div class="wp">
					<div id="kkpager">
					</div>
				</div>
			</div>
		</div>
		<!--  产品详情及产品选择弹窗 -->
		<!-- <span class="showProdLibAnddetail_btn" id="showProdLibAnddetail_btn">
            <i class="selectProdlNum">0</i>
        </span> -->
		<div class="ProdLibAnddetailBox">
			<div class="ProdLibAnddetail-bg"></div>
			<div class="rightMune">
				<div class="mune-cont">
					<div class="prodlib_panel" style="display:none">
						<p class="mune-til">已选产品列表</p>
						<div class="mune-list">
							<div class="cont-scrol">
								<table class="table" style="align:center;margin-top: 9px;text-align: center;" id="prodSelectedTable">
								</table>
							</div>
						</div>

						<div class="mune-back-box">
							<p class="selectProd">已选<span id="selectNum">0</span>件家具 </p>
							<a class="mune-back-btn" onclick="addAllSelectedProd()">全部添加</a>
						</div>
					</div>
					<div class="prodlib_panel">
						<p class="mune-til">产品信息<span onclick="displayProdList();" class="ico glyphicon glyphicon-remove-sign"></span></p>
						<div class="mune-list">
							<div class="cont-scrol">
								<table class="table" style="margin-top: 9px;text-align: center;border-collapse:collapse;border-spacing:0px;" id="selectFurDetailTable">
								</table>
							</div>
						</div>
						<div class="mune-back-box">
							<a class="mune-back-btn" id="selectThisProd">选择</a>
						</div>
					</div>
				</div>
			</div>
		</div>

	</div>
</div>

<div class="prodlibDetail" id="prodlibDetail">
	<div class="cetBox">
		<div class="pdname"><span></span><a class="backToPLib" onclick="hideProdlibDetail()" >&lt;返回</a></div>
		<div class="centerBOX clearfix">
			<div class="fl prototype"></div>
			<div class="fr detial"></div>
		</div>

	</div>

</div>

<div class="showAddProdTips" id="showAddProdTips">
	<span>添加成功</span>
</div>


<!--[if !IE]> -->
<script th:src="@{/common/js/jQuery-2.2.0.min.js}"></script>
<!-- <![endif]-->

<!--[if lte IE 8]>
<script th:src="@{/common/js/jquery-1.12.4.min.js}"></script>
<![endif]-->

<!--[if gt IE 8]>
<script th:src="@{/common/js/jQuery-2.2.0.min.js}"></script>
<![endif]-->
<script>

    //var test_el = $('#test-el');

    //test_el.html('begin');

</script>
<script th:src="@{/common/bootstrap-3.3.7-dist/js/bootstrap.min.js}"></script>
<script th:src="@{/common/lib/dialog/bootstrap-dialog.min.js}"></script>
<script th:src="@{/common/js/bootstrap-treeview.js}"></script>
<script th:src="@{/common/js/kkpager.js}"></script>
<script th:src="@{/common/lib/jquery-lightbox-0.5/js/jquery.lightbox-0.5.js}"></script>
<script th:src="@{/common/js/ajaxfileupload.js}"></script>
<script th:src="@{/common/js/imagePreview.js}"></script>
<script th:src="@{/common/lib/swiper/swiper.min.js}"></script>
<script th:src="@{/common/js/commonJs.js}"></script>

<script th:inline="javascript">


	var switchInput_tpl_defult = '<input type="text" class="" placeholder="长度" id="width"/> <span class="line">——</span> <input type="text" class="" placeholder="宽度" id="depth"/> <span class="line">——</span> <input type="text" class="" placeholder="高度" id="heigth"/> <span class="unit">mm</span>',
		switchInput_tpl_active = '<span class="fg"> <span class="fg_name">长度</span> <input type="text" class=""  id="width_l"/> <span class="line">——</span> <input type="text" class=""  id="width_u"/> <span class="unit">mm</span> </span> <span class="fg"> <span class="fg_name">宽度</span> <input type="text" class=""  id="depth_l"/> <span class="line">——</span> <input type="text" class=""  id="depth_u"/> <span class="unit">mm</span> </span> <span class="fg"> <span class="fg_name">高度</span> <input type="text" class=""  id="height_l"/> <span class="line">——</span> <input type="text" class=""  id="height_u"/> <span class="unit">mm</span> </span>',
		$insertinput = $('#insertinput'),
		$switchInputBtn = $('#switchInputBtn'),
		$insertinput_defult = $('#insertinput_defult'),
		$insertinput_act = $('#insertinput_act');

	function switchInput(self){
		
		var temp;
			$el = $(self),
			isAct = $el.hasClass('active');
		if(isAct){
			$el.removeClass('active');
			//temp = switchInput_tpl_defult;
			$switchInputBtn.html('精确筛选');
			$insertinput_defult.show();
			$insertinput_act.hide();
		}
		else{
			$el.addClass('active');
			//temp = switchInput_tpl_active;
			$switchInputBtn.html('常规筛选');
			$insertinput_defult.hide();
			$insertinput_act.show();
		}
		
		//$insertinput.html(temp);
	}


    var projPath = $('#projPath').val().slice(0,-1);

    //getFilterOpt('all');

    var orderByPrice = '',
        orderByWidth = '';


    $produceName = $('#produceName');

    $produceName.on('keydown', function (event) {
        if (event.keyCode === 13) {
            event.originalEvent.preventDefault();
            multyChoose();
        }
    });


    /* 产品名搜索 */
    $sereachBtn = $('#sereachBtn');

    $sereachBtn.click(function () {
        multyChoose();
    });
    /* 产品名搜索 end */



    var replaceprodNum = '';


    function resetFilterlistBoxFn() {

        var $selEl = $filterlistBox.find('.item'),
            len = $selEl.length,
            i = 0,
            temp;

        for(;i<len;i++){
            temp = $selEl.eq(i);
            temp.find('form')[0].reset();
            temp.find('.showSelText').html('请选择');
        }
    }


    //渲染筛选属性（下拉形式）
    function randerFilterOpt_xl(data) {

        $filterlistBox.html('');

        var len,
            opt_len,
            i1 = 0,
            i2,
            temp,
            tpl = '';

        tpl += factoryNameTpl;

        if (data && data.length) {
            len = data.length;

            for (; i1 < len; i1++) {

                temp = data[i1].values;
                opt_len = temp.length;
                i2 = 0;

                if (!opt_len) {
                    continue;
                }

                tpl += '<div class="item">';
                tpl += '<form>';
                tpl += '<span class="til">'+ data[i1].attrName + '：</span>';
                tpl += '<div class="optSel">';
                tpl += '<p class="showSelText" onclick="showChooseValFn(this)">请选择</p>';
                tpl += '<i class="ico"></i>';
                tpl += '<div class="hideValBox" onmouseleave="hideChooseValFn(event)">';
                tpl += '<ul>';

                for (; i2 < opt_len; i2++) {
                    tpl += '<li>';
                    tpl += '<label>';
                    tpl += '<input type="checkbox" class="cke-js" data-value="' + temp[i2].value + '" onchange="showChooseVal(this)" value="'+temp[i2].name+'" />';
                    tpl += '<span class="checkV">'+temp[i2].name+'</span>';
                    tpl += '</label>';
                    tpl += '</li>';
                }

                tpl += '</ul>';
                tpl += '</div>';
                tpl += '</div>';
                tpl += '</form>';
                tpl += '</div>';

            }
        }

        $filterlistBox.html(tpl);

    }



    //筛选属性
    function randerFilterOpt(data) {

        $filterlist.html('');
        if (!data || !data.length) {
            return;
        }

        var len = data.length,
            opt_len,
            i1 = 0,
            i2,
            temp,
            tpl = '';

        for (; i1 < len; i1++) {

            temp = data[i1].values;
            opt_len = temp.length;
            i2 = 0;

            if (!opt_len) {
                continue;
            }

            tpl += '<div class="fitem clearfix">';
            tpl += '<p class="til">' + data[i1].attrName + '：</p>';
            tpl += '<div class="opt">';

            for (; i2 < opt_len; i2++) {
                tpl += '<label class="opt_lab"><span onclick="filterSelOpt(event)" data-value="' + temp[i2].value + '"><i class="ico"></i>' + temp[i2].name + '</span></label>';
            }

            tpl += '</div>';
            tpl += '</div>';

        }

        $filterlist.html(tpl);

    }


    /*获取筛选属性*/
    var //$filterlist = $('#filterlist'),
        $filterlistBox = $('#filterlistBox'),
        $filterCancle_plod = $('#filterCancle_plod'),
        $filterSubBtn_plod = $('#filterSubBtn_plod');

    $filterCancle_plod.click(function () {
        //hideFilterBox();
        removeSelectArea(true);
    });

    $filterSubBtn_plod.click(function () {
        multyChoose();
        hideFilterBox();
        setSelectVal();
    });
    /*获取筛选属性 end*/


    //价格、尺寸排序
    var $formSortEl = $('.searechFrom .prodBySort');

    $formSortEl.click(function () {

        var $el = $(this),
            cname,
            rname,
            sort,
            oInd,
            name = $el.find('span').html(),
            isUp = $el.hasClass('showup'),
            isDown = $el.hasClass('showdown');

        if (!isUp && !isDown) {
            //向上
            cname = 'showup';
            sort = 'asc';
        }
        else if (isUp) {
            //向下
            cname = 'showdown';
            rname = 'showup';
            sort = 'desc';
        }
        else if (isDown) {
            //还原
            cname = '';
            rname = 'showdown';
            sort = '';
        }

        if (name === '价格') {
            oInd = 1;
            orderByPrice = sort;
            orderByWidth = '';
        } else {
            oInd = 0;
            orderByPrice = '';
            orderByWidth = sort;
        }

        if (rname) {
            $el.removeClass(rname);
        }

        if (cname) {
            $el.addClass(cname);
        }

        $formSortEl.eq(oInd).removeClass('showdown showup');

        //filterHandle('sort');
        multyChoose();

    });


    /*更多选项*/
    var $filterBtn = $('#filterBtn'),
        $filterBg = $('#filterBg'),
        $filterBox = $('#filterBox');

    $filterBg.click(function () {
        hideFilterBox();

        //$produceName.val(resetbeforData.pdname);
        $('#width').val(resetbeforData.width);
        $('#depth').val(resetbeforData.depth);
        $('#heigth').val(resetbeforData.height);
        //$('#factoryName').find("option:contains('"+resetbeforData.factoryName+"')").prop("selected",true);
        $('#minMoney').val(resetbeforData.minMoney);
        $('#maxMoney').val(resetbeforData.maxMoney);

        //改成
        //restoreSelect(resetbeforData.data);
    });

    function restoreSelect_xl(rData) {

        if (typeof rData != 'object' || !rData.length) {
            return;
        }

        var $list = $filterlistBox.find('.item'),
            len = rData.length,
            len2,
            $opt,
            i1 = 0,
            i2 = 0;

        for (; i1 < len; i1++) {

            $opt = $list.eq(rData[i1].key).find('.cke-js');

            len2 = rData[i1].val.length;
            i2 = 0;

            for (; i2 < len2; i2++) {
                $opt.eq(rData[i1].val[i2]).prop('checked',true);
            }
        }

    }

    function restoreSelect(rData) {

        if (typeof rData != 'object' || !rData.length) {
            return;
        }

        var $list = $filterlist.find('.fitem'),
            len = rData.length,
            len2,
            $opt,
            i1 = 0,
            i2 = 0;

        for (; i1 < len; i1++) {

            $opt = $list.eq(rData[i1].key).find('.opt_lab');

            len2 = rData[i1].val.length;
            i2 = 0;

            for (; i2 < len2; i2++) {
                $opt.eq(rData[i1].val[i2]).addClass('on-sel');

            }
        }

    }

    function showFilterBox() {
        $filterBg.show();

        var hei = (-$filterBox.height() + 1) + 'px';

        $filterBox.stop().animate({bottom: hei}, 500);
        $filterBtn.addClass('active');
    }

    function hideFilterBox() {

        $filterBtn.removeClass('active');
        $filterBg.hide();
        $filterBox.stop().animate({bottom: 0}, 500);
    }


    $filterBtn.click(function (event) {
        var self = $(this);

        if (self.hasClass('active')) {
            hideFilterBox();
        }
        else {
            showFilterBox();
        }

    });

    function filterSelOpt(e) {

        var ent = e || window.event,
            obj_js = ent.currentTarget || e.srcElement,
            $self = $(obj_js),
            $parent = $self.parents('.opt_lab');

        if (ent.stopPropagation) {
            ent.stopPropagation();
        }
        else {
            ent.cancelable = true;
        }

        if ($parent.hasClass('on-sel')) {
            $parent.removeClass('on-sel');
        }
        else {
            $parent.addClass('on-sel');
        }

        //改成直接发请求
        multyChoose();
        //改成直接发请求
    }

    /*更多选项 end*/


    //添加成功提示效果
    var $showAddProdTips = $('#showAddProdTips'),
        showAddProdTips_finise = true;

    function showAddProdTipsFn() {
        $showAddProdTips.stop().animate({top: '0px', opacity: 1}, 400, 'swing', function () {

            if (!showAddProdTips_finise) {
                return;
            }
            showAddProdTips_finise = false;
            setTimeout(function () {
                showAddProdTips_finise = true;
                $showAddProdTips.css({top: '-36px', opacity: 0});
            }, 1000);

        });
    }



    /*隐藏显示分类*/
    var //$justMask = $('#justMask'),
        $leftLine = $('#prodTypeListDiv'),
        $prodRightBox = $('#prodRightBox'),
        $prodlibTil = $prodRightBox.find('.prodlibTil'),
        $topMune = $prodRightBox.find('.topMune');

    function hideCagrage() {
        //$justMask.show();
        $leftLine.css('visibility', 'hidden');
        $prodlibTil.hide();
        $topMune.hide();
    }

    function showCagrage() {
        //$justMask.hide();
        $leftLine.css('visibility', 'visible');
        $prodlibTil.show();
        $topMune.show();
    }


    /* 产品详情展示 */
    var $prodlibDetail = $('#prodlibDetail'),
        $prodlibDetail_til = $prodlibDetail.find('.pdname span'),
        $prodlibDetail_proto = $prodlibDetail.find('.prototype'),
        $prodlibDetail_detial = $prodlibDetail.find('.detial'),
        prodlibDetail_data,
        $prodlibDetail_el,
        prodlibDetail_index;

    function showProdlibDetail() {
        $prodlibDetail.show();
        hideCagrage();
    }

    function hideProdlibDetail() {
        $prodlibDetail.hide();
        showCagrage();
    }

    function DetailrightInfo(data,replaceSku) {

        var goodsDetail = data,
            specification = goodsDetail.specification,
            proto_opt_len,
            detial_opt_v_len,
            tpl_detial = '',
            detial_len = specification.length,
            randomNum = Math.floor(Math.random() * 1000),
            img_len,
            count = data.basicInfo.countV,
            i1,
            i2;

        count = count ? count : 1;

        tpl_detial += '<div class="imgBox">';
        tpl_detial += '<div class="swiper-container" id="swiperId' + randomNum + '">';
        tpl_detial += '<div class="swiper-wrapper">';
        i1 = 0;
        img_len = goodsDetail.pics.length;
        for (; i1 < img_len; i1++) {
            tpl_detial += '<div class="swiper-slide">';
            tpl_detial += '<img src="' + goodsDetail.pics[i1] + '" alt="" />';
            tpl_detial += '</div>';
        }

        tpl_detial += '</div>';
        tpl_detial += '<div class="swiper-pagination"></div>';

        tpl_detial += '</div>';
        tpl_detial += '</div>';


        tpl_detial += '<dl>';
        tpl_detial += '<dt><span class="dtTil">厂商：</span></dt>';
        tpl_detial += '<dd>' + goodsDetail.basicInfo.factoryName + '</dd>';
        tpl_detial += '</dl>';

        tpl_detial += '<dl>';
        tpl_detial += '<dt><span class="dtTil">产品说明：</span></dt>';
        tpl_detial += '<dd>' + goodsDetail.basicInfo.briefDesc + '</dd>';
        tpl_detial += '</dl>';


        tpl_detial += '<dl id="specifications_info-js">';
        tpl_detial += '<dt><span class="dtTil">产品详情：</span></dt>';
        tpl_detial += '<dd>';

        proto_opt_len = specification.length;
        i1 = 0;
        for (; i1 < proto_opt_len; i1++) {
            tpl_detial += '<p><span class="til_l">' + specification[i1].name + '：</span><span class="val_l">';

            i2 = 0;
            detial_opt_v_len = specification[i1].values.length;

            for (; i2 < detial_opt_v_len; i2++) {
                tpl_detial += specification[i1].values[i2].name + ' ';
            }

            tpl_detial += '</span></p>';
        }

        tpl_detial += '</dd>';
        tpl_detial += '</dl>';


        tpl_detial += '<div class="costBox"><span class="dtTil">成本价：</span><span class="v" id="factoryPrice-js">' + goodsDetail.basicInfo.factoryPrice + '元</span></div>';
        tpl_detial += '<div class="selNum clearfix">';
        tpl_detial += '<span class="dtTil">数量</span>';
        tpl_detial += '<div class="num-box clearfix">';

        if (count > 1) {
            tpl_detial += '<a class="num-jian fl noselect" onclick="changeNum(this)">-</a>';
        }
        else {
            tpl_detial += '<a class="num-jian fl hui noselect" onclick="changeNum(this)">-</a>';
        }

        tpl_detial += '<div class="num-input fl">';
        tpl_detial += '<input class="count-inp-js" type="text" onblur="setCountNum(this,true)" onkeyup="setCountNum(this)" onafterpaste="setCountNum(this)" value="' + count + '" />';
        tpl_detial += '</div>';

        tpl_detial += '<a class="num-jia fl noselect" onclick="changeNum(this)">+</a>';
        tpl_detial += '</div>';
        tpl_detial += '</div>';
        tpl_detial += '<div class="btnBox">';
        if(replaceSku){
            tpl_detial += '<a onclick="prodlib_closeBtn()">取消</a>';
            tpl_detial += '<a onclick="updateSaleProd()" class="backBot">保存修改</a>';
            tpl_detial += '</div>';
        }else{
            if (!replaceprodNum) {
                tpl_detial += '<a onclick="addTolist_a(false)">加入清单列表（留在本页）</a>';
            }
            tpl_detial += '<a onclick="addTolist_a(true)">加入清单列表（关闭本页）</a>';
            tpl_detial += '</div>';
            tpl_detial += '<a onclick="hideProdlibDetail()" class="backBot">返回产品库</a>';
		}

        $prodlibDetail_detial.html(tpl_detial);

        new Swiper('#swiperId' + randomNum, {
            direction: 'horizontal',
            autoplay: true,
            loop: true,

            // 如果需要分页器
            pagination: {
                el: '.swiper-pagination',
            }

        });


    }

	//更新销售产品信息
	function updateSaleProd(){
        var skuId = '';
        var comp = prodlibDetail_data.goodsSelection.composition;
        for (var i = 0; i < comp.length; i++) {
            var value = comp[i];
            if (value.properties.toString() == prodlibDetail_index.toString()) {
                skuId = value.id;
                break;
            }
        }
        var countNum = $('#prodlibDetail').find('.num-input input').val();
        var saleProd = {"fid":updateSaleProdId,"skuId":skuId,"count":countNum}
        $.ajax({
            type: "Post",
            async: false,
            url: projPath + "/offerList/updateSaleProdSku",
            data: JSON.stringify(saleProd),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (result) {
                saleProdArray = [];
                if (window.top.document.getElementById('content')) {
                    window.top.document.getElementById('content').contentWindow.selectSaleProd(updateSaleProdAreaId);
                }
                else {
                    window.top.document.getElementById('saleProdFrame').contentWindow.location.reload(true);
                }
            },
            error: function (err) {
                alert("加载产品信息失败!" + err);
            }
        });

		window.top.hideProdLibPop();
	}

    //加入清单列表
    function addTolist_a(close) {

        if (!isAllSkuSelect) {
            alert('请选完产品属性');
            return;
        }

        var imgsrc = $prodlibDetail_el.find('.imgWp img').attr('src');
        //获取家具编号
        var fid = $prodlibDetail_el.find('input[name="productsCheckBox"]')[0].value;
        //获取家具名称
        var proname = $prodlibDetail_el.find('span[name="produceName"]')[0].title;
        //获取家具型号
        var modelNo = $prodlibDetail_el.find('input[name="modelNo"]').val();
        //产品企业
        var companyId = $prodlibDetail_el.find('input[name="companyId"]').val();

        var cost = $prodlibDetail_el.find('input[name="cost"]').val() * $("#buyRate_" + companyId).val();

        //获取产品分类ID
        var prodTypeId = $prodlibDetail_el.find('input[name="prodTypeId"]').val();

        var picSrc = imgsrc.substring(imgsrc.indexOf(filepath) + filepath.length, imgsrc.length);
        var countNum = $('#prodlibDetail').find('.num-input input').val();

        var skuId = '';

        var comp = prodlibDetail_data.goodsSelection.composition;
        for (var i = 0; i < comp.length; i++) {
            var value = comp[i];
            if (value.properties.toString() == prodlibDetail_index.toString()) {
                skuId = value.id;
                break;
            }
        }
        


        var saleProd = {
            prodName: proname,
            modelNo: modelNo,
            prodId: fid,
            picPath: picSrc,
            cost: cost,
            prodTypeId: prodTypeId,
            sellCompany: companyId,
            count: countNum,
            skuId: skuId
        };

        saleProdArray.push(saleProd);

        if (delSaleProdId != '') {
            replSaleProd();
        }

        form = {
            "prods": saleProdArray,
            "areaId": $("#areaId").val(),
            "offerId": $("#offerId").val()
        };

        $.ajax({
            type: "Post",
            async: true,
            url: projPath + "/offerList/toSaveProdSelected",
            data: JSON.stringify(form),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (result) {
                saleProdArray = [];
                if (window.top.document.getElementById('content')) {
                    window.top.document.getElementById('content').contentWindow.selectSaleProd($("#areaId").val());
                }
                else {
                    window.top.document.getElementById('saleProdFrame').contentWindow.location.reload(true);
                }
                //window.top.document.getElementById('content').contentWindow.selectSaleProd($("#areaId").val());

            },
            error: function (err) {
                alert("加载产品信息失败!" + err);
            }
        });


        if (close) {
            window.top.hideProdLibPop();
        }
        else {
            showAddProdTipsFn();
        }

    }

    var publicprodId;

    function gotoPductDetail(self) {

        var that = $(self),
            prodId = that.find('.hideVal').val();
        publicprodId = prodId;
        var skuIdValue = that.find(".hideSkuVal").val();
        $prodlibDetail_el = that;
        isAllSkuSelect = true;

        var url;

        if (replaceprodNum == '') {
            url = projPath + '/prodLib/prod/' + prodId + '/sku/'+skuIdValue+"/detail/"+1;
        }
        else {
            url = projPath + '/prodLib/prod/' + prodId + '/sku/'+skuIdValue+"/detail/"+replaceprodNum;
            //url = projPath + '/prodLib/prod/' + prodId + '/detail/' + replaceprodNum;
        }


        $.ajax({
            url: url,
            dataType: 'json',
            headers: {"with-selection": "true"},
            success: function (r) {

                if (r.meta && r.meta.code !== 200) {
                    alert(r.meta.msg);
                    return;
                }

                r.data.goodsDetail.basicInfo['countV'] = r.data.count;

                prodlibDetail_data = r.data;

                $prodlibDetail_til.html(r.data.goodsDetail.basicInfo.name);

                $prodlibDetail_proto.html('');
                $prodlibDetail_detial.html('');

                var goodsDetail = r.data.goodsDetail,
                    specification = goodsDetail.specification,
                    selection = r.data.goodsSelection,
                    selected = selection.selected,
                    properties = selection.properties,
                    properties_len = properties.length;


                for (var i = 0; i < properties_len; i++) {
                    var idx = selected.properties[i];
                    properties[i].values[idx].selected = true
                }


                prodlibDetail_index = selected.properties;

                //渲染
                var tpl_proto = '',
                    proto_len = properties_len,
                    proto_opt_len,
                    tpl_detial = '',
                    detial_len = specification.length,
                    detial_opt_len,
                    detial_opt_v_len,
                    img_len,
                    i1,
                    i2,
                    temp,
                    temp2,
                    ishui = '',
                    randomNum = Math.floor(Math.random() * 1000),
                    canme = '';

                i1 = 0;
                for (; i1 < proto_len; i1++) {

                    temp = properties[i1];
                    temp2 = temp.values;

                    tpl_proto += '<dl>';
                    tpl_proto += '<dt>' + temp.name + '</dt>';
                    tpl_proto += '<dd>';

                    proto_opt_len = temp2.length;
                    i2 = 0;
                    for (; i2 < proto_opt_len; i2++) {
                        canme = '';
                        if (temp2[i2].selected) {
                            canme = 'select';
                        }
                        else if (temp2[i2].disabled) {
                            canme = 'disabled';
                        }
                        tpl_proto += '<span onclick="protoSel(' + i1 + ',' + i2 + ',this)" class="opt noselect ' + canme + '" >' + temp2[i2].name + '</span>';
                    }

                    tpl_proto += '</dd>';
                    tpl_proto += '</dl>';

                }

                $prodlibDetail_proto.html(tpl_proto);

                checkDisabel();

                DetailrightInfo(r.data.goodsDetail,replaceSku);

                showProdlibDetail();

            },
            error: function () {
                alert('加载详情失败');
            }

        });


        //渲染
        showProdlibDetail();

    }

    function checkDisabel() {

        var $el = $('#prodlibDetail .prototype dl').eq(0).find('.opt.select').eq(0),
            ind = $el.index(),
            el = $el.eq(0);
        protoSel(0, ind, el, true);
    }

    //标记有没有全部选中Sku属性
    var isAllSkuSelect = true;

    //选中产品属性
    function protoSel(i1, i2, self, isCheck) {

        var $el = $(self),
            $all_dl_el = $el.parents('.prototype').find('dl'),
            properties = prodlibDetail_data.goodsSelection.properties,
            propertyIndex = i1,
            propertyValueIndex = i2,
            propertyDisabled = $el.hasClass('disabled'),
            isSelect = $el.hasClass('select'),
            opt_len = prodlibDetail_data.goodsSelection.properties.length,
            temp_str,
            temp_i,
            temp_arr = [],
            temp_arr2,
            compositions = prodlibDetail_data.goodsSelection.composition,
            exp,
            countNum = $('.count-inp-js').val(),
            propValue,
            disabled;

        //首先属性应该是可选的,不可选则直接返回
        /*
    2018-4-16修改 仿造京东不可选也可以选
    if (propertyDisabled) {
      console.log('propertyDisabled');
      return;
    } */

        countNum = countNum ? countNum > 0 ? countNum : 1 : 1;

        // 取消该属性下的所有值的选中状态+设置当前选中状态
        if (!isCheck) {
            $el.siblings('.opt').removeClass('select');
            if (isSelect) {
                $el.removeClass('select');
            }
            else {
                $el.addClass('select');
            }
        }

        if (propertyDisabled) {

            $el.removeClass('disabled');
            temp_i = 0;
            opt_len = prodlibDetail_data.goodsSelection.properties.length; //多少条属性标题
            temp_str = '';

            for (; temp_i < opt_len; temp_i++) {
                if (temp_i == i1) {
                    temp_arr.push(i2);
                }
                else {
                    temp_arr.push('\\d');
                }
            }

            exp = new RegExp(temp_str);

            temp_i = 0;
            for (; temp_i < opt_len; temp_i++) {
                if (temp_i == i1) {
                    $el.siblings().removeClass('disabled');
                    continue;
                }
                temp_arr2 = temp_arr.slice();
                propValue = properties[temp_i].values;
                for (var j = 0; j < propValue.length; j++) {

                    temp_arr2[temp_i] = j;
                    exp = new RegExp('^' + temp_arr2.toString() + "$");
                    disabled = true;
                    for (var k = 0; k < compositions.length; k++) {
                        var compProp = compositions[k].properties;
                        var meet = exp.test(compProp.toString());
                        if (meet) {
                            disabled = false;
                            break;
                        }
                    }
                    
                    if (disabled) {
                        $all_dl_el.eq(temp_i).find('span.opt').eq(j).removeClass('select').addClass('disabled');
                    }
                    else {
                        $all_dl_el.eq(temp_i).find('span.opt').eq(j).removeClass('disabled select');
                    }

                }

            }

            return;
        }

        // 检查当下的选择
        var checkRes = checkSelection($all_dl_el);
        var selectedPropertyStr = checkRes.selectedPropertyStr;
        var selectedPropertyIndexs = checkRes.selectedPropertyIndexs;
        prodlibDetail_index = selectedPropertyIndexs;

        var selectedPropertyIndexs2 = selectedPropertyIndexs.slice(),
            selectedPI_v = 0,
            selectedPI_i = 0,
            priceRangeObj,
            selectedPI_len = selectedPropertyIndexs.length;

        for (; selectedPI_i < selectedPI_len; selectedPI_i++){
            selectedPI_v += selectedPropertyIndexs2[selectedPI_i];
            if (selectedPropertyIndexs2[selectedPI_i] == -1){
                selectedPropertyIndexs2[selectedPI_i] = '\\d';
            }
        }

        // 重新计算disable
        //当第i个属性未确定,其余均取当前选择的结果,那么看第i个属性所有的值有哪些是存在于组合的

        for (var i = 0; i < selectedPropertyIndexs.length; i++) {
            var tmpCompProp = selectedPropertyIndexs.slice(0);
            // 将未选中项替换为对应的正则\\d+
            for (var j = 0; j < tmpCompProp.length; j++) {
                if (j != i && tmpCompProp[j] == -1)
                    tmpCompProp[j] = '\\d+';
            }
            // 遍历第i个属性的所有取值
            propValue = properties[i].values;
            for (var j = 0; j < propValue.length; j++) {
                tmpCompProp[i] = j;//第i个属性取第j个值
                exp = new RegExp('^' + tmpCompProp.toString() + "$");//生成对应的正则
                disabled = true;
                for (var k = 0; k < compositions.length; k++) {
                    var compProp = compositions[k].properties;
                    var meet = exp.test(compProp.toString());//判断
                    if (meet) {
                        disabled = false;
                        break;
                    }
                }
                
                if (disabled) {
                    $all_dl_el.eq(i).find('span.opt').eq(j).addClass('disabled');
                }
                else {
                    $all_dl_el.eq(i).find('span.opt').eq(j).removeClass('disabled');
                }

            }
        }

        if (isCheck) {
            return;
        }

        // 更新商品详情
        var skuId = checkRes.skuId;
        if (skuId) {

            $.ajax({
                url: projPath + '/prodLib/prod/' + publicprodId + '/sku/' + skuId + '/detail/' + countNum,
                datatype: 'json',
                success: function (r) {

                    if (r.meta && r.meta.code !== 200) {
                        alert(r.meta.msg);
                        return;
                    }

                    r.data.goodsDetail.basicInfo['countV'] = r.data.count;

                    DetailrightInfo(r.data.goodsDetail,replaceSku);

                },
                error: function () {
                    alert('加载失败');
                }
            });

        }
        else{

            var priceRangeObj = getPriceRange(selectedPropertyIndexs2, compositions);

            var priceSTR = '';

            if(priceRangeObj.maxPrice === priceRangeObj.minPrice){
                priceSTR = priceRangeObj.maxPrice+'元';
            }
            else{
                priceSTR = priceRangeObj.minPrice+'元 ~ '+ priceRangeObj.maxPrice+'元';
            }

            $('#factoryPrice-js').html(priceSTR);
            $('#specifications_info-js').remove();

		}


    }

    function getPriceRange(selectedPropertyIndexs2, compositions){

        var exp2 = new RegExp('^' + selectedPropertyIndexs2.toString() + "$");
        var i = 0,
            maxPrice = 0,
            minPrice = 0,
            isfirst = true,
            len = compositions.length,
            compProp;

        for(;i<len;i++){

            compProp = compositions[i].properties;

            if (exp2.test(compProp.toString())) {
                if (isfirst){
                    isfirst = false;
                    maxPrice = compositions[i].factoryPrice;
                    minPrice = compositions[i].factoryPrice;
                    continue;
                }
                if (compositions[i].factoryPrice > maxPrice) {
                    maxPrice = compositions[i].factoryPrice;
                }

                if (compositions[i].factoryPrice < minPrice) {
                    minPrice = compositions[i].factoryPrice;
                }
            }

        }

        return {
            minPrice: minPrice,
            maxPrice: maxPrice
        }


    }


    function checkSelection($dl) {
        // 获取所有的选中规格尺寸数据
        var properties = prodlibDetail_data.goodsSelection.properties;
        var needSelectNum = properties.length;
        var curSelectNum = 0;
        var selectedPropertyIndexs = [];
        var selectedPropertyStr = "";
        for (var i = 0; i < properties.length; i++) {
            var childs = properties[i].values;
            var s = false;
            for (var j = 0; j < childs.length; j++) {

                if ($dl.eq(i).find('span.opt').eq(j).hasClass('select')) {
                    curSelectNum++;
                    s = true;
                    selectedPropertyIndexs.push(j);
                    selectedPropertyStr = selectedPropertyStr + childs[j].name + "，";
                }
            }
            if (!s)
                selectedPropertyIndexs.push(-1);
        }
        if (selectedPropertyStr.lastIndexOf("，") !== -1)
            selectedPropertyStr = selectedPropertyStr.substr(0, selectedPropertyStr.length - 1)

        var skuId = '';
        if (needSelectNum == curSelectNum) {
            isAllSkuSelect = true;
            var comp = prodlibDetail_data.goodsSelection.composition;
            for (var i = 0; i < comp.length; i++) {
                var value = comp[i];
                if (value.properties.toString() == selectedPropertyIndexs.toString()) {
                    skuId = value.id;
                    break;
                }
            }
            
        }
        else {
            isAllSkuSelect = false;
        }

        return {
            "skuId": skuId,
            "selectedPropertyIndexs": selectedPropertyIndexs,
            "selectedPropertyStr": selectedPropertyStr,
        };
    }


    function setCountNum(self, isBlur) {

        var $el = $(self),
            val = $el.val(),
            $prent = $el.parent(),
            $addBtn = $prent.siblings('.num-jia'),
            $curBtn = $prent.siblings('.num-jian'),
            max = 999;

        if (val.length == 1) {
            val = val.replace(/[^1-9]/g, '');

        } else {
            val = val.replace(/\D/g, '');
        }

        if (val == '' && !isBlur) {
            $el.val(val);
            return;
        }

        if (val == '' || isNaN(val)) {
            val = 1;
        }

        val = parseInt(val);

        $addBtn.removeClass('hui');
        $curBtn.removeClass('hui');

        if (val <= 1) {
            $curBtn.addClass('hui');
        }
        else if (val >= max) {
            $addBtn.addClass('hui');
            val = max;
        }

        $el.val(val);

    }

    //数量变化
    function changeNum(self) {

        var $btn = $(self),
            $btn_add,
            $btn_cur,
            $valEl,
            val,
            change = 1,
            max = 999;

        if ($btn.hasClass('hui')) {
            return;
        }

        if ($btn.hasClass('num-jian')) {
            change = -1;
            $btn_cur = $btn;
            $btn_add = $btn.siblings('.num-jia');
        }

        if (!$btn.hasClass('num-jian')) {
            $btn_add = $btn;
            $btn_cur = $btn.siblings('.num-jian');
        }

        $valEl = $btn.siblings('.num-input').find('input');
        val = parseInt($valEl.val());

        val += change;

        $btn_add.removeClass('hui');
        $btn_cur.removeClass('hui');

        if (val <= 1) {
            $btn_cur.addClass('hui');
            $btn_add.removeClass('hui');
        }
        else if (val >= max) {
            $btn_add.addClass('hui');
            $btn_cur.removeClass('hui');
        }

        $valEl.val(val);

    }


    //清除搜索图片
    function resetSubmitImg() {

        var hasImg = $('#sereachImgInp').val() ? true : false;

        $('#sereachImgInp').val('');
        $('#preViweImg').attr('src', '');
        $('#fingerprint').val('');
        $('#select_imgPane .imgfileBox span').html('点击上传本地图片');
        /* isResetImg_token = true; */

        if (!hasImg) {
            return;
        }
        var fid = $('#prodTypeId').val();
        showProdLibMsg(fid, 1);

    }

    var isSereachbyImg_token = false,
        isResetImg_token = false;

    function submitImg() {

        var extname,
            size,
            $img = $('#sereachImgInp'),
            img_name = $img.val(),
            pid = $('#prodTypeId').val();

        if (!img_name) {

            alert('请上传图片');
            return;
        }
        else {
            extname = img_name.substring(img_name.lastIndexOf(".") + 1, img_name.length).toLowerCase();
            if (extname != "jpeg" && extname != "jpg" && extname != "gif" && extname != "png") {
                alert('格式不正确,支持的图片格式为：JPEG、jpg、GIF、PNG');
                return false;
            }

            size = $img[0].files[0].size;
            if (size > 2097152) {
                alert('图片大小不能超过2M');
                return false;
            }

        }

        if (!pid || pid === 'all') {
            pid = '';
        }

        $('#select_imgPane').slideUp();

        isSereachbyImg_token = true;

        window.top.showHomeLoading();

        $.ajaxFileUpload
        (
            {
                url: projPath + '/imageSearch/searchSimialImage', //用于文件上传的服务器端请求地址
                secureuri: false, //是否需要安全协议，一般设置为false
                fileElementId: 'sereachImgInp', //文件上传域的ID
                dataType: 'application/json', //返回值类型 一般设置为json
                proTypeId: pid,
                pageSize: pageImgCountNum,
                contentType: "application/json; charset=utf-8",
                success: function (data, status)  //服务器成功响应处理函数
                {
                    window.top.hideHomeLoading();
                    var res,
                        reg = /^<pre.+?>/g,
                        datas,
                        dataInd;

                    dataInd = data.indexOf('{');

                    res = data.slice(dataInd, -6);

                    if (res == 'false') {
                        alert('搜索失败');
                        return false;
                    }
                    else {
                        datas = JSON.parse(res);
                    }


                    showProdPic(datas.prodLibProds);
                    if (!datas.produces.length) {
                        return;
                    }

                    $fingerprint.val(datas.imgUuid);

                    if (pid == '') {
                        pid = '';
                    }

                    showPageInfo(pid, datas.producesCount, true);
                    //$('#prodPicTable td .daskImg').lightBox();

                },
                error: function (data, status, e)//服务器响应失败处理函数
                {

                    window.top.hideHomeLoading();
                    if (data.responseText.indexOf('a damaged picture') !== -1) {
                        alert('请上传正确的图片的格式');
                    }
                    else {
                        alert('搜索失败');
                    }

                    /* console.log(data);
                console.log(status);
                console.log(e); */
                }
            }
        )
        return false;
    }


    /* 关闭产品库 */
    function prodlib_closeBtn() {
        window.top.hideProdLibPop();
    }

    var //$firstPageBtn = $('#firstPage-btn'),      //产品库分页 的首页按钮
        $prodlibTilName = $('#prodlibTilName'),   //产品库标题
        $fingerprint = $('#fingerprint');         //图片指纹值

    var saleProdArray = [];
    var delSaleProdId = '';
    var filepath = $('input[name="filepath"]').val();

    var treeMuneDataList;

    var $treejqEl = $('#prodTypeListDiv');

    var returnTreeStrVal;

    function returnTreeStr(arr, target, depth) {

        var len = arr.length,
            i = 0;

        for (; i < len; i++) {
            if (arr[i].fid === target[depth]) {
                returnTreeStrVal += arr[i].text + '&gt;';

                if (depth < (target.length - 1) && arr[i].nodes.length > 0) {
                    returnTreeStr(arr[i].nodes, target, ++depth);
                }

            }
        }

    }


    function getTreeLaryer(path) {

        if (!path) {
            return '全部产品';
        }

        var temp = path.slice(0, -1),
            arr = temp.split(';');

        if (arr.length <= 0) {
            return '全部产品';
        }

        returnTreeStrVal = '';
        returnTreeStr(globalTreeData, arr, 0);

        returnTreeStrVal = returnTreeStrVal.slice(0, -4);

        return returnTreeStrVal;

    }

    function getFilterOpt(fid, cb) {

        if (fid === '') {
            fid = 'all';

            /* $filterlist.html('');
        return; */
        }

        $.ajax({
            url: projPath + '/customProdType/queryAttr/' + fid,
            success: function (r) {

                var filterOptData;
                if (!r || !r.length) {
                    filterOptData = [];
                }
                else {
                    filterOptData = r.slice();
                }
                //改成的
                randerFilterOpt_xl(filterOptData);
                //randerFilterOpt(filterOptData);
                if (typeof cb === 'function') {
                    cb();
                }

            },
            error: function () {
                alert('加载筛选属性失败');
            }

        })

    }


    function ReSetTreeMune(fid) {

        var $treeBtn = $('#prodTypeListDiv .tree-dropdown-toggle-js'),
            len = $treeBtn.length,
            str = "",
            curInd,
            temp,
            path,
            i = 0;

        $treeBtn.removeClass('active ');

        for (; i < len; i++) {
            temp = $treeBtn.eq(i).data('fid');
            if (fid == temp) {
                curInd = i;
                $treeBtn.eq(i).addClass('active');
                path = $treeBtn.eq(i).data('path');
                break;
            }
        }

        if ((len = path.split(';').length) > 1) {

            temp = $treeBtn.eq(i);
            len = len - 1;
            i = 1;

            for (; i < len; i++) {
                temp = temp.parents('.submenu').css('display', 'block');
                temp.siblings('.tree-dropdown-toggle-js').addClass('showB');
            }
        }

        /* if(temp.slice(0,-1).split(';').length > 1){
        str = $treeBtn.eq(i).parent('.submenu').sibings('.tree-dropdown-toggle-js').find('.treeNmae-js').html() + '&gt;';
        str += $treeBtn.eq(i).find('.treeNmae-js').html();
    }
    else{
        str = $treeBtn.eq(i).find('.treeNmae-js').html();
    } */

        $prodlibTilName.html(getTreeLaryer(path));

        /*var dataNodes = cpResult(treeMuneDataList,fid),
        nodeId;


    function findData(data){
        if(typeof data === 'object' && data.length > 0){

            var i = 0,
                len = data.length;

            for(;i<len;i++){

                if(data[i].fid == fid){
                    $prodlibTilName.html(data[i].text);
                    return;
                }else if(typeof data[i].nodes === 'object' && data[i].nodes.length > 1){
                    findData(data[i].nodes);
                }

            }

        }
    }

    if(fid || fid ===0){
        findData(dataNodes)
    }

    $('#prodTypeListDiv').treeview({
        data: dataNodes, // 数据源
        showCheckbox: false, //是否显示复选框
        highlightSelected: true, //是否高亮选中
        iconInd : 'r',
        //nodeIcon: 'glyphicon glyphicon-user', //节点上的图标 glyphicon-globe
        expandIcon:'glyphicon-plus',
        collapseIcon:'glyphicon-minus',
        emptyIcon: 'glyphicon', //没有子节点的节点图标
        multiSelect: false, //多选
        onNodeSelected: function (event, data) {

            console.log(globalTreeData);
            $fingerprint.val('');
            $('#preViweImg').attr('src','');

            var lev;

            if(!data.path){
                is_topLevel = 'yes';
            }
            else{
                lev = data.path.split(';');
                if(lev.length == 1){
                    is_topLevel = 'yes';
                }
                else if(lev.length == 2 && !lev[1]){
                    is_topLevel = 'yes';
                }
            }

            $treejqEl.treeview('expandNode', [ data.nodeId, { levels: 2, silent: true } ]);

            $prodlibTilName.html(getTreeLaryer(data.path));
            //选中的分类data.fid 显示对应的产品图片信息等
            removeSelectArea();
            showProdLibMsg(data.fid,1);
            getFilterOpt(data.fid);
            isSereachbyImg_token = false;
        }
    });

    nodeId = $('#prodTypeListDiv').find('li.node-selected').data('nodeid');
    $('#prodTypeListDiv').treeview('collapseAll', { silent: true });
    $('#prodTypeListDiv').treeview('revealNode', [ nodeId, { iconInd : 'r',silent: true } ]);*/

        getFilterOpt(fid);
    }


    var globalTreeData = [[${nodes}]];


    //服务端的写法
    var categorySlider = easyTree({
        isShowALL: true
    });


    $('.tree-dropdown-toggle-js').click(function () {
        var that = $(this);

        categorySlider(that);
        $('.tree-dropdown-toggle-js').removeClass('active');
        that.addClass('active');

        $fingerprint.val('');
        $('#preViweImg').attr('src', '');

        var lev,
            depath = that.data('depath'),
            path = that.data('path'),
            fid = that.data('fid');

        if (depath == 0) {
            is_topLevel = 'yes';
        }

        $prodlibTilName.html(getTreeLaryer(path));
        hideFilterBox();
        //选中的分类data.fid 显示对应的产品图片信息等
        removeSelectArea();

        showProdLibMsg(fid, 1);
        getfactoryTpl(fid,function(){
            getFilterOpt(fid);
        });

        isSereachbyImg_token = false;

    });

    function resetFilterPaneLocation() {
        var hei = $filterBox.height();
        $filterBox.css('bottom', hei + 'px');
    }


    function showProdLibMsg_setVal(fid, isReflash, areaId, offerId, replSaleProdId) {
        if (areaId) {
            $("#areaId").val(areaId);
        }
        if (offerId) {
            $("#offerId").val(offerId);
        }

        if (isReflash) {
            // 清空购物车
            $("#prodSelectedTable").html("");
        }

        if (replSaleProdId) {
            delSaleProdId = replSaleProdId;
        }

        $("#prodTypeId").val(fid);
    }

    function selectTreeNode(fid) {
        ReSetTreeMune(fid);
    }

    var isFirstInprodLib = true;

    //切换分类清除筛选条件
    function swichCagrogeClear() {

        orderByPrice = '';
        orderByWidth = '';

    }

    //产品列表属性编辑进详情进来的情况
    var updateSaleProdAreaId = '';
    var replaceSku = false;
	function showSkuDetail(skuId,areaId,offerId,prodId,count){
        //alert("skuId:"+skuId+" areaId:"+areaId+" offerId:"+offerId+" prodId:"+prodId+" count:"+count);
        publicprodId = prodId;
        updateSaleProdAreaId = areaId;
		var url = projPath + '/prodLib/prod/' + prodId + '/sku/'+skuId+"/detail/"+count;
        $.ajax({
            async: false,
            url: url,
            dataType: 'json',
            headers: {"with-selection": "true"},
            success: function (r) {

                if (r.meta && r.meta.code !== 200) {
                    alert(r.meta.msg);
                    return;
                }

                r.data.goodsDetail.basicInfo['countV'] = r.data.count;

                prodlibDetail_data = r.data;

                $prodlibDetail_til.html(r.data.goodsDetail.basicInfo.name);

                $prodlibDetail_proto.html('');
                $prodlibDetail_detial.html('');

                var goodsDetail = r.data.goodsDetail,
                    specification = goodsDetail.specification,
                    selection = r.data.goodsSelection,
                    selected = selection.selected,
                    properties = selection.properties,
                    properties_len = properties.length;


                for (var i = 0; i < properties_len; i++) {
                    var idx = selected.properties[i];
                    properties[i].values[idx].selected = true
                }


                prodlibDetail_index = selected.properties;

                //渲染
                var tpl_proto = '',
                    proto_len = properties_len,
                    proto_opt_len,
                    tpl_detial = '',
                    detial_len = specification.length,
                    detial_opt_len,
                    detial_opt_v_len,
                    img_len,
                    i1,
                    i2,
                    temp,
                    temp2,
                    ishui = '',
                    randomNum = Math.floor(Math.random() * 1000),
                    canme = '';

                i1 = 0;
                for (; i1 < proto_len; i1++) {

                    temp = properties[i1];
                    temp2 = temp.values;

                    tpl_proto += '<dl>';
                    tpl_proto += '<dt>' + temp.name + '</dt>';
                    tpl_proto += '<dd>';

                    proto_opt_len = temp2.length;
                    i2 = 0;
                    for (; i2 < proto_opt_len; i2++) {
                        canme = '';
                        if (temp2[i2].selected) {
                            canme = 'select';
                        }
                        else if (temp2[i2].disabled) {
                            canme = 'disabled';
                        }
                        tpl_proto += '<span onclick="protoSel(' + i1 + ',' + i2 + ',this)" class="opt noselect ' + canme + '" >' + temp2[i2].name + '</span>';
                    }

                    tpl_proto += '</dd>';
                    tpl_proto += '</dl>';

                }

                $prodlibDetail_proto.html(tpl_proto);

                checkDisabel();
                replaceSku = true;
                $(".backToPLib").hide();
                DetailrightInfo(r.data.goodsDetail,replaceSku);

                showProdlibDetail();

            },
            error: function () {
                alert('加载详情失败');
            }

        });
    }

    //用于更新销售产品信息
    var updateSaleProdId = '';
    //根据选中的分类data.fid 显示对应的产品图片信息等
    function showProdLibMsg(fid, startPage, isReflash, areaId, offerId, replSaleProdId, pnum) {

        if(fid.indexOf(":") != -1){
            //产品列表属性编辑进详情进来的情况才会执行
            var saleId = fid.split(":");
            updateSaleProdId = saleId[0];
            var skuId = saleId[1];
            showSkuDetail(skuId,areaId,offerId,replSaleProdId,pnum);
            return;
        }

        showProdLibMsg_setVal(fid, isReflash, areaId, offerId, replSaleProdId);

        if (fid === '') {
            is_topLevel = 'yes';
        }

        if (replSaleProdId) {
            selectTreeNode(fid);
        }

        if (pnum) {
            replaceprodNum = pnum;
        }

        var dataForm = {
            prodTypeId: fid,
            depth: '',
            heigth: '',
            width: '',
            maxMoney: '',
            minMoney: '',
            prodName: '',
            startPage: startPage,
            pageSize: pageImgCountNum,
            dynamicCondition: [],
            orderByPrice: '',
            orderByWidth: ''
        };

        $.ajax({
            url: projPath + "/prod/toProducesList",
            type: "Post",
            async: false,
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(dataForm),
            success: function (result) {

                /* 动态查询区域 */
                //selectAreaBoxForm(result.proPropertyVals);
                //动态查询区域替换成下面
                //randerFilterOpt(result.proPropertyVals);

                //展示产品信息
                showProdPic(result.data.prodIntros);
                showPageInfo(fid, result.data.prodCount);

                //厂商
                /*var factory_tpl = '',
                len = result.companys.length,
                i = 0;
            factory_tpl += '<option value="">请选择</option>';

            for(;i<len;i++){
                factory_tpl += '<option value="'+result.companys[i].id+'">'+result.companys[i].name+'</option>';
            }*/

                //$('#factoryName').html(factory_tpl);

                if (isFirstInprodLib) {
                    resetIfrHei();
                }
                isFirstInprodLib = false;
                //$('#prodPicTable td .daskImg').lightBox();

            },
            error: function (err) {
                alert("加载产品信息失败!");
            }
        });

    }

    //分页用
    function showProdLibMsg_fy(fid, startPage, isReflash, areaId, offerId, replSaleProdId) {

        showProdLibMsg_setVal(fid, isReflash, areaId, offerId, replSaleProdId);

        var dataForm = {},
            fingerprint = $fingerprint.val();


        if (fingerprint) {
            dataForm["imgUuid"] = fingerprint;
        }

        dataForm["prodTypeId"] = fid;
        dataForm["startPage"] = startPage;
        dataForm["pageSize"] = pageImgCountNum;

        $.ajax({
            url: projPath + "/prod/toProducesList",
            type: "Post",
            async: false,
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(dataForm),
            success: function (result) {

                //展示产品信息
                showProdPic(result.data.prodIntros);

                /* if(isResetImg_token){
                isResetImg_token = false;
                isSereachbyImg_token = false;
                showPageInfo(fid,result.producesCount,true);
            } */

                //$('#prodPicTable td .daskImg').lightBox();
            },
            error: function (err) {
                alert("加载产品信息失败!");
            }
        });

    }

    function sereachImgBypaging(pid, pNum) {
        var data,
            similarImgIds;
        similarImgId = $('#fingerprint').val().split(',');

        data = {similarImgIds: similarImgId, pageNum: pNum, proTypeId: pid};

        data = JSON.stringify(data);

        $.ajax({
            url: projPath + "/imageSearch/turnPage",
            type: "get",
            async: false,
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            data: data,
            success: function (result) {

                console.log(result);

            },
            error: function (err) {
                alert("加载产品信息失败!");
            }
        });

    }

    function mouseoverEvent(obj) {
        $(obj).find(".dask").css('display', 'block');
    }

    function onmouseoutEvent(obj) {
        $(obj).find(".dask").css('display', 'none');
    }

    var $kkpager = $('#kkpager'),
        $prodPicTable_tbody = $('#prodPicTable tbody');

    //展示产品信息（第一条sku图片+产品名称）
    function showProdPic(produces) {

        $("#prodPicTable tbody").html("");

        //产品数
        var prodsLen = produces.length,
            colNum = 5; //每行多少个图片


        //总共有rowcount行
        /* var rowcount = Math.ceil(prodsLen/3); */
        var rowcount = Math.ceil(prodsLen / colNum);

        if (!prodsLen) {
            $prodPicTable_tbody.html('<td style="width:100%;height:175px;padding-bottom: 5px;margin-right:80px;text-align:center;font-size:22px" title="">暂无数据</td>');
            $kkpager.html('');
            //$firstPageBtn.hide();
            return;
        }
        else {
            //$firstPageBtn.show();
        }

        var thumbnail = "<div style=\"width:100%;height:210px;margin: 0px auto;\" class=\"thumbnail\" onclick='gotoPductDetail(this)'>";
        var caption = "<div style=\"width:100%;height:10px;padding: 0px;\" class=\"caption\"><nobr>";
        var tail = "</div></nobr></div>";
        var priceStr = '';

        var $tr;
        for (var j = 0; j < prodsLen; j++) {

            var img = "";
            var checkboxe0 = "";
            var content = "";
            var content2 = "";
            var htmltext = "";
            var prodId = '<input type="hidden" class="hideVal" value="' + produces[j].prodId + '"/>';
            var skuId = '<input type="hidden" class="hideSkuVal" value="' + produces[j].skuId + '"/>';

            if (filepath + produces[j].path) {
                img += "<div class='imgWp'><img style=\"position:relative;\" src='" + produces[j].mainPic + "' alt=''></div>";
            }
            else {
                img += "<div class='imgWp'><img style=\"position:relative;\" src=" + projPath + "'/common/img/noPic.png' alt=''></div>";
            }

            if (parseInt(produces[j].minPrice) === parseInt(produces[j].maxPrice)) {
                priceStr = '<p class="textHidden" style="font-size: 14px; text-align: center; color: #f60; width: 100%; padding-top: 25px; ">¥' + produces[j].minPrice + '</p>';
            }
            else {
                priceStr = '<p class="textHidden" style="font-size: 14px; text-align: center; color: #f60; width: 100%; padding-top: 25px; ">¥' + produces[j].minPrice + '~¥' + produces[j].maxPrice + '</p>';
            }


            checkboxe0 += "<div class=\"\" style=\"margin-left: 173px;\"><input type=\"checkbox\" class=\"styled styled-primary\"  name=\"productsCheckBox\" value='' onclick=\"\" style=\"display:none\"/><label></label></div>";
            content += "<span class=\"zxx_text_overflow_1\" name=\"produceName\" title=\"" + produces[j].prodName + "\">" + produces[j].prodName + "</span><input type='hidden' name=\"modelNo\" value='' /><input type='hidden' name=\"cost\" value='' /><input type='hidden' name=\"prodTypeId\" value='' /><input type='hidden' name=\"companyId\" value='' />";
            //content2 = "<div class=\"dask\"><a href=\""+filepath+""+sku.files[i].path+"\" class=\"daskImg\"></a><p><button type=\"button\" onclick=\"selectFurDetail(event)\" class=\"btn btn-primary\">详情</button>&nbsp;&nbsp;&nbsp;<button name=\"picbtn\" type=\"button\" onclick=\"picChecked(event)\" class=\"btn btn-primary\">添加</button></p></div>";
            htmltext += thumbnail + prodId + skuId + img + caption + content + priceStr + checkboxe0 + content2 + tail;
            $td = $('<td class="prodlib_td" title="" name="proimg"></td>');
            $td.html(htmltext);
            var tdCounttmp = 0;
            if (null != $tr && "" != $tr) {
                tdCounttmp = $tr[0].childNodes.length;
            }
            var newrowsign = tdCounttmp % colNum;
            if (0 == newrowsign) {
                $tr = $('<tr></tr>');
            }
            $tr.append($td);
            $("#prodPicTable tbody").append($tr);

        }
        //补充缺少的td
        var lastTrTdCount = $("#prodPicTable tbody tr:eq(" + ($("#prodPicTable tbody tr").length - 1) + ") td").size();
        if (colNum != lastTrTdCount && null != $tr) {
            var tmp = colNum - lastTrTdCount;
            //var $ltd = $('<td style="width:200px;height:175px;padding-bottom: 5px;margin-right:80px" title=""></td>');

            for (var j = 0; j < tmp; j++) {
                var ltd = document.createElement('td');
                ltd.className = "prodlib_td";
                //ltd.style.cssText = 'width:100%;height:210px;padding-bottom: 5px;margin-right:80px';
                $tr[0].appendChild(ltd);
            }
        }
        //补充一行,使得分页显示位置不变
        /*if ($("#prodPicTable tbody tr").length < 2) {
            var apptr = 2 - $("#prodPicTable tbody tr").length;
            for (var k = 0; k < apptr; k++) {
                $tr = $('<tr></tr>');
                //var $ltd = $('<td style="width:200px;height:195px;padding-bottom: 5px;margin-right:80px" title=""></td>');
                var ltd = document.createElement('td');
                ltd.style.cssText = 'width:100%;height:210px;padding-bottom: 5px;margin-right:80px';
                $tr[0].appendChild(ltd);
                //$tr.append($ltd);
                $("#prodPicTable tbody").append($tr);
            }
        }*/
    }

    //复制对象数组
    function cpResult(arr, fid) {

        var newArray = [];
        var allProduct = {fid: "", text: "全部产品", path: '', nodes: "", state: {selected: true}},
            ind,
            temp_srt,
            temp_beg,
            temp_end;


        if (fid || fid === 0) {
            allProduct.state.selected = '';
        }

        arr.unshift(allProduct);

        for (var i = 0; i < arr.length; i++) {
            newArray.push(arr[i]);
        }


        var datastr = JSON.stringify(newArray);
        datastr = datastr.replace(/name/g, "text");
        datastr = datastr.replace(/children/g, "nodes");

        if (fid && fid !== 0) {
            ind = datastr.indexOf('"fid":"' + fid + '"');
            temp_beg = datastr.slice(0, ind);
            temp_end = datastr.slice(ind);
            temp_srt = '"state":{"expanded":"true","selected":"true"},';
            datastr = temp_beg + temp_srt + temp_end;
        }

        newArray = JSON.parse(datastr);
        return newArray;
    }

    //获取选中的产品
    function getCheckedProds() {
        var prodSeleted = [];
        /*$('input[name="productsCheckBox"]:checked').each(function(){
        prodSeleted.push($(this).val());
    });*/
        $("#prodSelectedTable tr").each(function () {
            prodSeleted.push($(this).attr("fid"));
        });
        return prodSeleted;
    }

    //改变选中的个数
    function selectNum() {
        var prodSeleted = getCheckedProds();
        $("#selectNum").html("已选 " + prodSeleted.length + " 件家具");
    }

    //显示家具详情
    function displayDetail() {
        $(".selectFurList").css('display', 'none');
        $(".selectFurDetail").css('display', 'block');
    }

    //显示已选产品列表
    function displayProdList() {
        hiddenLeftMune();
        showLeftMune(0);
        /* $(".selectFurList").css('display','block');
    $(".selectFurDetail").css('display','none'); */
    }

    var matSizeColInfo;

    function getProdSkuInfo(produceId) {
        $.ajax({
            type: "GET",
            async: false,
            url: projPath + "/product/getMatSizeColArray",
            data: "produceId=" + produceId,
            success: function (result) {
                matSizeColInfo = result;
            },
            error: function (err) {
                alert("加载产品详情信息失败!");
            }
        });
    }

    function addCurrProInfo(name, value) {
        var modelVal = '<span style="float:left;width:225px">';
        var Html = "<span style=\"word-break:normal; width:auto; float:left;white-space:pre-wrap;word-wrap : break-word ;overflow: hidden ;padding-left: 8px;\">" + name + "：</span>";

        if ("型号" == name) {
            var j = 0;
            for (var i = 0; i < value.length; i++) {
                if (null != value[i]) {
                    modelVal += value[i] + "</br>";
                    j++;
                }
            }
            Html += modelVal + '</span>';
        } else {
            Html += modelVal + value + '</span>';
        }
        var $tr = $('<tr style="text-align: left;"></tr>');
        $td = $('<td style="width: 200px;"></td>');
        $td.html(Html);
        $tr.append($td);
        $("#selectFurDetailTable").append($tr);
    }

    function showMoreProdInfo(js_el) {
        var self = $(js_el),
            $moreShowBox = self.parents('.ShowinfoBox').find('.moreShowBox');

        if (self.hasClass('active')) {
            self.removeClass('active');
            $moreShowBox.slideUp();
        }
        else {
            self.addClass('active');
            $moreShowBox.slideDown();
        }

    }


    function addmatSizeColInfo(name, arr) {
        var Header;
        var Tail;
        var sparet;

        var baseShowBox = '<div class="baseShowBox">',
            moreShowBox = '<div class="moreShowBox">',
            showInfoLimitNum = 6,
            itemNum = arr.length,
            str1 = '',
            str2 = '',
            tpl = '';

        function magerStr() {

            if (showInfoLimitNum < itemNum) {

                for (var i = 0; i < showInfoLimitNum; i++) {
                    if ("型号" == name) {
                        str1 += arr[i] + '</br>';
                    } else {
                        str1 += arr[i].optValue + '</br>';
                    }
                }

                baseShowBox += '<a class="showMoreProdInfo" onclick="showMoreProdInfo(this)"></a>' + str1 + '</div>';

                for (var i = showInfoLimitNum; i < itemNum; i++) {

                    if ("型号" == name) {
                        str2 += arr[i] + '</br>';
                    } else {
                        str2 += arr[i].optValue + '</br>';
                    }
                }

                moreShowBox += str2;

                tpl += '<div class="ShowinfoBox">' + baseShowBox + moreShowBox + '</div>';

            }
            else {

                for (var i = 0; i < arr.length; i++) {
                    if ("型号" == name) {
                        str1 += arr[i] + '</br>';
                    } else {
                        str1 += arr[i].optValue + '</br>';
                    }
                }

                baseShowBox += str1 + '</div>';
                tpl += '<div class="ShowinfoBox">' + baseShowBox + '</div>';
            }

        }

        if ("尺寸" == name || '型号' == name) {
            Header = "<div style=\"position:relative;padding-left: 8px;\"><span class=\"fl\">" + name + "：</span>";
            Tail = "</div>";
        } else {
            Header = "<p style=\"padding-left: 8px;word-wrap: break-word;word-break: break-all;\">" + name + "：";
            Tail = "</p>";
            sparet = "&nbsp;"
        }

        var span = "";
        //颜色/材质

        if (name == '尺寸' || '型号' == name) {
            magerStr();
        }
        else {

            span += '<span style="display:inline-block;word-wrap: break-word;word-break: break-all;width: 225px;vertical-align: top;">'
            for (var i = 0; i < arr.length; i++) {

                if ("风格" == name) {
                    span += arr[i].designId + sparet;
                } else {
                    span += arr[i].optValue + sparet;
                }
            }

            span += '</span>';
        }


        var Html = Header + tpl + span + Tail;
        //var Html = Header + tpl + Tail;
        var $tr = $('<tr style="text-align: left;"></tr>');
        $td = $('<td style="width: 200px;"></td>');
        $td.html(Html);
        $tr.append($td);
        $("#selectFurDetailTable").append($tr);
    }

    var select_obj;
    $('#selectThisProd').click(function () {
        picChecked(select_obj);
        displayProdList();
    });

    //家具详情
    function selectFurDetail(currobj2) {

        var ent,
            obj_js,
            currobj;

        if (currobj2 instanceof Event) {
            ent = currobj2 || window.event;
            obj_js = ent.currentTarget || e.srcElement;
            currobj = $(obj_js);

            if (ent.stopPropagation) {
                ent.stopPropagation();
            }
            else {
                ent.cancelable = true;
            }
        }
        else {
            currobj = currobj2;
        }

        select_obj = currobj;
        $("#selectFurDetailTable").html("");
        //显示家具详情
        displayDetail();
        obj = $(currobj).parents(".thumbnail").find('img')[0];
        //获取图片的src
        var imgsrc = obj.src;
        //获取家具编号
        var fid = $(obj).parents(".thumbnail").find('input[name="productsCheckBox"]')[0].value;
        //获取家具名称
        var proname = $(obj).parents(".thumbnail").find('span[name="produceName"]')[0].title;
        //获取家具型号
        var modelNo = $($(obj).parents(".thumbnail").find('input[name="modelNo"]')[0]).val();

        //添加第一行图片
        var imgTd = "<img src=\"" + imgsrc + "\" class=\"prodlibInfoImg\" />";
        var $tr1 = $('<tr style=""></tr>');
        $td1 = $('<td style="width: 200px;"></td>');
        $td1.html(imgTd);
        $tr1.append($td1);
        $("#selectFurDetailTable").append($tr1);
        //名称
        addCurrProInfo("名称", proname);
        //型号
        /*addCurrProInfo("型号",modelNo);*/
        //查询sku信息
        getProdSkuInfo(fid);
        addmatSizeColInfo("型号", matSizeColInfo.modelNoList);
        //addCurrProInfo("型号",matSizeColInfo.modelNoList);
        //风格
        addmatSizeColInfo("风格", matSizeColInfo.prodDesignList);
        //颜色
        addmatSizeColInfo("颜色", matSizeColInfo.colorList);
        //材质
        addmatSizeColInfo("材质", matSizeColInfo.materialList);
        //尺寸
        addmatSizeColInfo("尺寸", matSizeColInfo.sizeList);

        showLeftMune(1);
    }

    //添加家具
    function picChecked(currobj2) {
        //显示已选产品列表
        var ent,
            obj_js,
            currobj;

        if (currobj2 instanceof Event) {
            ent = currobj2 || window.event;
            obj_js = ent.currentTarget || e.srcElement;
            currobj = $(obj_js);

            if (ent.stopPropagation) {
                ent.stopPropagation();
            }
            else {
                ent.cancelable = true;
            }
        }
        else {
            currobj = currobj2;
        }

        displayProdList();
        obj = $(currobj).parents(".thumbnail").find('img')[0];
        //获取图片的src
        //错误写法(出现中文乱码)：var imgsrc = obj.src;
        var imgsrc = $(obj).attr('src');
        //获取家具编号
        var fid = $(obj).parents(".thumbnail").find('input[name="productsCheckBox"]')[0].value;
        //获取家具名称
        var proname = $(obj).parents(".thumbnail").find('span[name="produceName"]')[0].title;
        //获取家具型号
        var modelNo = $($(obj).parents(".thumbnail").find('input[name="modelNo"]')[0]).val();
        //产品企业
        var companyId = $($(obj).parents(".thumbnail").find('input[name="companyId"]')[0]).val();

        var cost = $($(obj).parents(".thumbnail").find('input[name="cost"]')[0]).val() * $("#buyRate_" + companyId).val();

        //获取产品分类ID
        var prodTypeId = $($(obj).parents(".thumbnail").find('input[name="prodTypeId"]')[0]).val();

        var imgTd = "<img src=\"" + imgsrc + "\" style=\"width:66px;height:50px\"/>";
        var pronameHtml = "<span class=\"textOverflow\" style='width:130px;display: block;' title=\"" + proname + "\">" + proname + "</span>";
        var del = "<span></span><a href=\"javascript:void(0);\" onclick=\"delProduct(this,'" + fid + "')\" style='float: right;color: red;'>删除</a>";
        var proDel = pronameHtml + del;

        var div0 = "<div>";
        var $tr = $('<tr fid="' + fid + '"></tr>');
        $td = $('<td style="width: 74px;height: 55px;"></td>');
        $td.html(imgTd);
        $tr.append($td);
        $td2 = $('<td style="" class=""></td>');
        $td2.html(proDel);
        $tr.append($td2);
        $("#prodSelectedTable").append($tr);

        var picSrc = imgsrc.substring(imgsrc.indexOf(filepath) + filepath.length, imgsrc.length);

        var saleProd = {
            prodName: proname,
            modelNo: modelNo,
            prodId: fid,
            picPath: picSrc,
            modelNo: modelNo,
            cost: cost,
            prodTypeId: prodTypeId,
            sellCompany: companyId
        };

        saleProdArray.push(saleProd);

        selectNum();
    }

    //删除已选的家具
    function delProduct(obj, fid) {
        var tr = obj.parentNode.parentNode;
        var table = tr.parentNode;
        table.removeChild(tr);
        selectNum();
        // 清除数组

        for (var i = 0; i < saleProdArray.length; i++) {
            var saleProd = saleProdArray[i];
            if (saleProd.prodId == fid) {
                saleProdArray.splice(i, 1);
                break;
            }
        }
    }

    var tmpfid;

    //根据fid显示页码
    function showPageInfo(fid, producesCount, isbyImg) {

        $("#kkpager").html("");
        var pageCount = Math.ceil(producesCount / pageImgCountNum);
        //切换分类,重新生成分页
        if (isSereachbyImg_token) {
            isbyImg = true;
        }

        if (tmpfid != fid || isbyImg) {

            tmpfid = fid;
            $.getScript(projPath + '/common/js/kkpager.js', function () {
                //生成分页控件
                kkpager.generPageHtml({
                    pno: 1,
                    mode: 'click', //设置为click模式
                    //总页码
                    total: pageCount,
                    //总数据条数
                    totalRecords: producesCount,
                    isShowCurrPage: false,
                    isShowTotalRecords: true,
                    isShowGoPageNum: false,
                    //点击页码、页码输入框跳转、以及首页、下一页等按钮都会调用click
                    //适用于不刷新页面，比如ajax
                    click: function (n) {

                        //这里可以做自已的处理
                        showProdLibMsg_fy(tmpfid, n);
                        //处理完后可以手动条用selectPage进行页码选中切换
                        this.selectPage(n);
                    },
                    //getHref是在click模式下链接算法，一般不需要配置，默认代码如下
                    getHref: function (n) {
                        return '#';
                    },
                    isShowTotalRecords: false,
                    lang: {
                        firstPageText: '',
                        firstPageTipText: '',
                        lastPageText: '',
                        lastPageTipText: '',
                        prePageText: '上一页',
                        prePageTipText: '上一页',
                        nextPageText: '下一页',
                        nextPageTipText: '下一页',
                        totalPageBeforeText: '共',
                        totalPageAfterText: '页',
                        currPageBeforeText: '当前第',
                        currPageAfterText: '页',
                        totalInfoSplitStr: '/',
                        totalRecordsBeforeText: '共',
                        totalRecordsAfterText: '条数据',
                        gopageBeforeText: ' 到',
                        gopageButtonOkText: '确定',
                        gopageAfterText: '页',
                        buttonTipBeforeText: '第',
                        buttonTipAfterText: '页'
                    }

                });
            });

        } else {
            //生成分页控件
            kkpager.generPageHtml({
                pno: 1,
                mode: 'click', //设置为click模式
                //总页码
                total: pageCount,
                //总数据条数
                totalRecords: producesCount,
                isShowCurrPage: false,
                isShowTotalRecords: true,
                isShowGoPageNum: false,
                //点击页码、页码输入框跳转、以及首页、下一页等按钮都会调用click
                //适用于不刷新页面，比如ajax
                click: function (n) {

                    //这里可以做自已的处理
                    showProdLibMsg_fy(tmpfid, n);

                    //处理完后可以手动条用selectPage进行页码选中切换
                    this.selectPage(n);
                },
                //getHref是在click模式下链接算法，一般不需要配置，默认代码如下
                getHref: function (n) {
                    return '#';
                },
                isShowTotalRecords: false,
                lang: {
                    firstPageText: '',
                    firstPageTipText: '',
                    lastPageText: '',
                    lastPageTipText: '',
                    prePageText: '上一页',
                    prePageTipText: '上一页',
                    nextPageText: '下一页',
                    nextPageTipText: '下一页',
                    totalPageBeforeText: '共',
                    totalPageAfterText: '页',
                    currPageBeforeText: '当前第',
                    currPageAfterText: '页',
                    totalInfoSplitStr: '/',
                    totalRecordsBeforeText: '共',
                    totalRecordsAfterText: '条数据',
                    gopageBeforeText: ' 到',
                    gopageButtonOkText: '确定',
                    gopageAfterText: '页',
                    buttonTipBeforeText: '第',
                    buttonTipAfterText: '页'
                }

            });
        }

    }


    function getfactoryNameFn(){
        var $el = $('#filterFactory'),
            $opt,
            arr = [],
            len,
            i = 0;

        if(!$el.length){
            return '';
        }

        $opt = $el.find('.cke-js');
        len = $opt.length;

        for(;i<len;i++){
            if($opt.eq(i).is(':checked')){
                arr.push($opt.eq(i).data('value'));
            }
        }

        if(!arr.length){
            return '';
        }

        return arr;

    }


    /* window.onresize = function () {
    window.top.SetOffWinHeight();
}; */

    var pageImgCountNum = 15; //每页显示数量

    function doSubmit(addParam) {

        var width = parseInt($("#width").val());
    	var depth = parseInt($("#depth").val());
    	var heigth = parseInt($("#heigth").val());
    	var prodTypeId = $("#prodTypeId").val();
    	var minMoney = parseInt($("#minMoney").val());
    	var maxMoney = parseInt($("#maxMoney").val());
    	var material = $('input[name="materialRadio"]:checked').val();
    	var produceName = $("#produceName").val();
        var factoryName = getfactoryNameFn();//$('#factoryName').val();
    	var width_Lower,
    		width_Upper,
    		depth_Lower,
    		depth_Upper,
    		heigth_Lower,
    		heigth_Upper;
    	
    	if(!$switchInputBtn.hasClass('active')){
    		
    			width_Lower = Math.max(width - 100,0);
    			width_Upper = width + 100;
				depth_Lower = Math.max(depth - 100,0);
				depth_Upper = depth + 100;
				height_Lower = Math.max(heigth - 100,0);
				height_Upper = heigth + 100;
    	}
    	else{
    		var width_l = parseInt($('#width_l').val()),
    			width_u = parseInt($('#width_u').val()),
    			depth_l = parseInt($('#depth_l').val()),
    			depth_u = parseInt($('#depth_u').val()),
	    		height_l = parseInt($('#height_l').val()),
	    		height_u = parseInt($('#height_u').val());
    		
    		
    		if(!width_l || width_l < 0){
    			width_Lower = 0;
    		}
    		else{
    			width_Lower = width_l;
    		}
    		
    		if(!width_u || width_u < 0){
    			width_Upper = 0;
    		}
    		else{
    			width_Upper = width_u;
    		}
    		
    		if(!depth_l || depth_l < 0){
    			depth_Lower = 0;
    		}
    		else{
    			depth_Lower = depth_l;
    		}
    		
    		if(!depth_u || depth_u < 0){
    			depth_Upper = 0;
    		}
    		else{
    			depth_Upper = depth_u;
    		}
    		
    		if(!height_l || height_l < 0){
    			height_Lower = 0;
    		}
    		else{
    			height_Lower = height_l;
    		}
    		
    		if(!height_u || height_u < 0){
    			height_Upper = 0;
    		}
    		else{
    			height_Upper = height_u;
    		}
    		
    	}

        dataForm = {
            "prodTypeId": prodTypeId,
/*            "width": width,
            "depth": depth,
            "heigth": heigth, */
            "minMoney": minMoney,
            "maxMoney": maxMoney,
            "material": material,
            "prodName": produceName,
            "startPage": 1,
            "pageSize": pageImgCountNum,
            orderByPrice: orderByPrice,
            orderByWidth: orderByWidth,
        };

        if (addParam) {
            if (publicIsType('array', addParam.val)) {
                dataForm['dynamicCondition'] = addParam.val;
            }
            if (addParam.xixie && addParam.xixie.length > 0) {
                dataForm['seriesName'] = addParam.xixie;
            }

        }

        if (factoryName) {
            dataForm['companyIds'] = factoryName;
            //dataForm['companyIds'].push(factoryName);
        }

        var fingerprint = $fingerprint.val();

        if (fingerprint) {
            dataForm['imgUuid'] = fingerprint;
        }

    	if(width_Lower > 0){
    		dataForm['widthLower'] = width_Lower;
    	}
    	
    	if(width_Upper > 0){
    		dataForm['widthUpper'] = width_Upper;
    	}
    	
    	if(depth_Lower > 0){
    		dataForm['depthLower'] = depth_Lower;
    	}
    	
    	if(depth_Upper > 0){
    		dataForm['depthUpper'] = depth_Upper;
    	}
    	
    	if(height_Lower > 0){
    		dataForm['heigthLower'] = height_Lower;
    	}
    	
    	if(height_Upper > 0){
    		dataForm['heigthUpper'] = height_Upper;
    	}

        $.ajax({
            type: "Post",
            async: false,
            url: projPath + "/prod/toProducesList",
            data: JSON.stringify(dataForm),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (result) {

                /* 动态查询区域 */
                //selectAreaBoxForm(result.proPropertyVals);
                //randerFilterOpt(result.proPropertyVals);
                //展示产品信息、

                showProdPic(result.data.prodIntros);
                if (!result.data.prodIntros.length) {
                    return;
                }
                showPageInfoBydataForm(dataForm, result.data.prodCount);
                //$('#prodPicTable td .daskImg').lightBox();
            },
            error: function (err) {
                alert("加载产品信息失败!");
            }
        });
    }

    function showProdLibMsgBydataForm(dataForm) {
        $.ajax({
            type: "Post",
            async: false,
            url: projPath + "/prod/toProducesList",
            data: JSON.stringify(dataForm),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (result) {
                //展示产品信息
                showProdPic(result.data.prodIntros);
                //$('#prodPicTable td .daskImg').lightBox();
            },
            error: function (err) {
                alert("加载产品信息失败!");
            }
        });
    }

    var dataFormtmp;

    //根据fid显示页码
    function showPageInfoBydataForm(dataForm, producesCount) {
        $("#kkpager").html("");
        var isbyImg = $('#sereachImgInp').val() ? true : 0;
        var pageCount = Math.ceil(producesCount / pageImgCountNum);
        //切换分类,重新生成分页
        if (dataFormtmp != dataForm) {
            dataFormtmp = dataForm;
            $.getScript(projPath + '/common/js/kkpager.js', function () {
                //生成分页控件
                kkpager.generPageHtml({
                    pno: 1,
                    mode: 'click', //设置为click模式
                    //总页码
                    total: pageCount,
                    //总数据条数
                    totalRecords: producesCount,
                    isShowCurrPage: false,
                    isShowTotalRecords: true,
                    isShowGoPageNum: false,
                    //点击页码、页码输入框跳转、以及首页、下一页等按钮都会调用click
                    //适用于不刷新页面，比如ajax
                    click: function (n) {
                        //这里可以做自已的处理
                        dataFormtmp.startPage = n;
                        showProdLibMsgBydataForm(dataFormtmp);
                        //处理完后可以手动条用selectPage进行页码选中切换
                        this.selectPage(n);
                    },
                    //getHref是在click模式下链接算法，一般不需要配置，默认代码如下
                    getHref: function (n) {
                        return '#';
                    },
                    isShowTotalRecords: false,
                    lang: {
                        firstPageText: '',
                        firstPageTipText: '',
                        lastPageText: '',
                        lastPageTipText: '',
                        prePageText: '上一页',
                        prePageTipText: '上一页',
                        nextPageText: '下一页',
                        nextPageTipText: '下一页',
                        totalPageBeforeText: '共',
                        totalPageAfterText: '页',
                        currPageBeforeText: '当前第',
                        currPageAfterText: '页',
                        totalInfoSplitStr: '/',
                        totalRecordsBeforeText: '共',
                        totalRecordsAfterText: '条数据',
                        gopageBeforeText: ' 到',
                        gopageButtonOkText: '确定',
                        gopageAfterText: '页',
                        buttonTipBeforeText: '第',
                        buttonTipAfterText: '页'
                    }

                });
            });

        } else {
            //生成分页控件
            kkpager.generPageHtml({
                pno: 1,
                mode: 'click', //设置为click模式
                //总页码
                total: pageCount,
                //总数据条数
                totalRecords: producesCount,
                isShowCurrPage: false,
                isShowTotalRecords: true,
                isShowGoPageNum: false,
                //点击页码、页码输入框跳转、以及首页、下一页等按钮都会调用click
                //适用于不刷新页面，比如ajax
                click: function (n) {
                    //这里可以做自已的处理
                    showProdLibMsgBydataForm(dataFormtmp);
                    //处理完后可以手动条用selectPage进行页码选中切换
                    this.selectPage(n);
                },
                //getHref是在click模式下链接算法，一般不需要配置，默认代码如下
                getHref: function (n) {
                    return '#';
                },
                isShowTotalRecords: false,
                lang: {
                    firstPageText: '',
                    firstPageTipText: '',
                    lastPageText: '上一页',
                    lastPageTipText: '上一页',
                    prePageText: '',
                    prePageTipText: '',
                    nextPageText: '下一页',
                    nextPageTipText: '下一页',
                    totalPageBeforeText: '共',
                    totalPageAfterText: '页',
                    currPageBeforeText: '当前第',
                    currPageAfterText: '页',
                    totalInfoSplitStr: '/',
                    totalRecordsBeforeText: '共',
                    totalRecordsAfterText: '条数据',
                    gopageBeforeText: ' 到',
                    gopageButtonOkText: '确定',
                    gopageAfterText: '页',
                    buttonTipBeforeText: '第',
                    buttonTipAfterText: '页'
                }
            });
        }
    }

    function addAllSelectedProd() {
        if (delSaleProdId != '') {
            replSaleProd();
        }

        form = {
            "prods": saleProdArray,
            "areaId": $("#areaId").val(),
            "offerId": $("#offerId").val()
        };

        $.ajax({
            type: "Post",
            async: true,
            url: projPath + "/offerList/toSaveProdSelected",
            data: JSON.stringify(form),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (result) {
                window.top.document.getElementById('content').contentWindow.selectSaleProd($("#areaId").val());
                saleProdArray = [];
                window.top.hideProdLibPop();
            },
            error: function (err) {
                alert("加载产品信息失败!" + err);
            }
        });
    }

    function replSaleProd() {
        $.ajax({
            type: "GET",
            async: true,
            url: projPath + "/offerList/deleteSaleProd",
            data: "saleProdId=" + delSaleProdId,
            success: function (result) {

            },
            error: function (err) {
            }
        });
    }

    //var $selectProdlNum = $('.showProdLibAnddetail_btn .selectProdlNum');

    //改变选中的个数
    function selectNum() {
        var prodSeleted = getCheckedProds();
        $("#selectNum").html(prodSeleted.length);
        //$selectProdlNum.html(prodSeleted.length);
    }

    /*  产品库关闭时清空件数 */
    function clearCountItem() {
        $("#selectNum").html(0);
        //$selectProdlNum.html(0);
    }

    /* 选择产品时清除查询表单的内容 */

    var $form_el = $('#form'),
        resetbeforData = {
            pdname: '',
            width: '',
            depth: '',
            height: '',
            factoryName: '',
            minMoney: '',
            maxMoney: '',
            data: []
        };


    function setSelectVal() {

        var $wid = $('#width'),
            $dep = $('#depth'),
            $hei = $('#heigth'),
            $min = $('#minMoney'),
            $max = $('#maxMoney');
            //$fname = $('#factoryName');

        //resetbeforData.pdname = $produceName.val();
        resetbeforData.width = $wid.val();
        resetbeforData.depth = $dep.val();
        resetbeforData.height = $hei.val();
        //resetbeforData.factoryName = $fname.find("option:selected").text();
        resetbeforData.minMoney = $min.val();
        resetbeforData.maxMoney = $max.val();
        //改成
        //resetbeforData.data = getSelectAllVal_xl(true);
        //resetbeforData.data = getSelectAllVal(true);
    }


    function removeSelectArea(isResetBtn) {

        var $wid = $('#width'),
            $dep = $('#depth'),
            $hei = $('#heigth'),
            $min = $('#minMoney'),
            $max = $('#maxMoney');
            //$fname = $('#factoryName');

        if (isResetBtn) {

            //resetbeforData.pdname = $produceName.val();
            resetbeforData.width = $wid.val();
            resetbeforData.depth = $dep.val();
            resetbeforData.height = $hei.val();
            //resetbeforData.factoryName = $fname.find("option:selected").text();
            resetbeforData.minMoney = $min.val();
            resetbeforData.maxMoney = $max.val();
            //改成
            resetbeforData.data = getSelectAllVal_xl(true);
            //resetbeforData.data = getSelectAllVal(true);

            //改成
            //去除选中的样式
            //resetFilterlistBoxFn();
            //$filterlist.find('.opt_lab').removeClass('on-sel');

        }
        else {

            $('.searechFrom .prodBySort').removeClass('showup showdown');

            resetbeforData = {
                pdname: '',
                width: '',
                depth: '',
                height: '',
                factoryName: '',
                minMoney: '',
                maxMoney: '',
                data: []
            };

            swichCagrogeClear();
        }

        $produceName.val('');
        $('#width').val('');
        $('#depth').val('');
        $('#heigth').val('');
        //$('#factoryName').find("option:eq(0)").prop("selected", true);
        $('#minMoney').val('');
        $('#maxMoney').val('');
        //$form_el[0].reset();
    }

    /* 产品信息及添加产品菜单 */
    var $leftMune = $('.ProdLibAnddetailBox');
    //$leftMune_btn = $('#showProdLibAnddetail_btn'),
    $prodPanel = $leftMune.find('.prodlib_panel'),
        $leftMune_bg = $('.ProdLibAnddetail-bg');

    /* $leftMune_btn.on('click',function(){

    if($leftMune.hasClass('active')){
        hiddenLeftMune();
    }
    else{
        showLeftMune(0);
    }

}); */


    function hiddenLeftMune() {
        $leftMune.removeClass('active');
        $prodPanel.hide();
    }

    function showLeftMune(ind) {
        $prodPanel.eq(ind).show();
        $leftMune.addClass('active');
    }

    $leftMune_bg.on('click', function (e) {
        e.stopPropagation();
        hiddenLeftMune();
    });

    /* 动态筛选 */

    var $prodTypeId_sl = $('#prodTypeId'),
        prodTypeId_sl,
        $slectAreaBox_sl = $('#selectAreaBox'),
        MaxColNum_sl = 4,
        multy_single_sel,
        is_topLevel = 'no',
        is_paging = 'no',
        tpls_size = '',
        tpls_cost = '',
        tpls_factory = '',
        tpls_prodName = '',
        tpls_material_strat = '',
        tpls_material_btn = '',
        tpls_material_end = '',
        tpls_material_more = '',
        tpls_submit_btn = '',
        tpls_select_img = '';


    tpls_select_img += '<a class="select_imgBox" id="select_imgBox"><i></i><span>以图搜图</span></a>';
    tpls_select_img += '<div id="select_img_downPane" class="img_downPane">';
    tpls_select_img += '<div class="pane" id="select_imgPane">';
    tpls_select_img += '<dl class="clearfix">';
    tpls_select_img += '<dt>上传图片：</dt>';
    tpls_select_img += '<dd>';
    tpls_select_img += '<div class="imgfileBox">';
    tpls_select_img += '<span>点击上传本地图片</span>';
    tpls_select_img += '<a><input type="attachment" name="imagefile" id="sereachImgInp" onchange="sereachImgChange(this);"/></a>';
    tpls_select_img += '</div>';
    tpls_select_img += '</dd>';
    tpls_select_img += '</dl>';
    /*  tpls_select_img += '<dl class="clearfix">';
     tpls_select_img += '<dt>搜索范围：</dt>';
     tpls_select_img += '<dd>';
         tpls_select_img += '<select name="" id="">';
             tpls_select_img += '<option value="">全部分类</option>';
             tpls_select_img += '<option value="">类别1</option>';
             tpls_select_img += '<option value="">类别2</option>';
         tpls_select_img += '</select>';
     tpls_select_img += '</dd>';
 tpls_select_img += '</dl>'; */
    tpls_select_img += '<div class="btnBox">';
    tpls_select_img += '<a onclick="submitImg();">搜索</a>';
    tpls_select_img += '<a onclick="resetSubmitImg();">重置</a>';
    tpls_select_img += '</div>';
    tpls_select_img += '</div>';
    tpls_select_img += '</div>';


    tpls_size += '<tr>';
    tpls_size += '<td>';
    tpls_size += '<label class="opt-til"><span>尺寸/mm：</span></label> ';
    tpls_size += '</td>';
    tpls_size += '<td class="clearfix ">';
    tpls_size += '<div class="input-size">';
    tpls_size += '<input class="" type="text" id="width" placeholder="长度" value="">';
    tpls_size += '<span>-</span>';
    tpls_size += '<input class="" type="text" id="depth" placeholder="宽度" value="">';
    tpls_size += '<span>-</span>';
    tpls_size += '<input class="" type="text" id="heigth" placeholder="高度" value="">';
    tpls_size += '</div>';
    tpls_size += '</td>';
    tpls_size += '</tr>';

    tpls_cost += '<tr>';
    tpls_cost += '<td>';
    tpls_cost += '<label class="opt-til"><span>成本/元：</span></label>';
    tpls_cost += '</td>';
    tpls_cost += '<td class="clearfix ">';
    tpls_cost += '<div class="input-size">';
    tpls_cost += '<input class="" type="text" id="minMoney" placeholder="¥" value="">';
    tpls_cost += '<span>-</span>';
    tpls_cost += '<input class="" type="text" id = "maxMoney" placeholder="¥" value="">';
    tpls_cost += '</div>';
    tpls_cost += '</td>';
    tpls_cost += '</tr>';

    tpls_factory += '<tr>';
    tpls_factory += '<td>';
    tpls_factory += '<label class="opt-til"><span>厂商：</span></label>';
    tpls_factory += '</td>';
    tpls_factory += '<td class="clearfix ">';
    tpls_factory += '<div style="padding:7px 0 0 14px;width:488px"><select style="margin:0;outline:none;box-shadow:none !important" class="form-control" name="" id="factoryName"></select></div>';
    tpls_factory += '</td>';
    tpls_factory += '</tr>';


    tpls_prodName += '<tr>';
    tpls_prodName += '<td>';
    tpls_prodName += '<label class="opt-til"><span>产品名称：</span></label>';
    tpls_prodName += '</td>';
    tpls_prodName += '<td class="clearfix " style="overflow:visible">';
    tpls_prodName += '<div class="input-size" style="position:relative">';
    tpls_prodName += '<input class="big-inp" type="text" id="produceName" placeholder="产品名称" value="">';//+tpls_select_img;
    tpls_prodName += '</div>';
    tpls_prodName += '</td>';
    tpls_prodName += '<td rowspan="3" width="220px">';
    tpls_prodName += '<div id="showSereachImg" class="showSereachImg"><div class="ajust2018DivBtns" style="padding-top:46px"><a class="btns ajust2018Btns" onclick="multyChoose(this)" >筛选</a></div><!--<img th:src="" alt="图片预览" id="preViweImg" />--></div>';
    tpls_prodName += '</td>';
    tpls_prodName += '</tr>';

    tpls_submit_btn += '<tr>';
    tpls_submit_btn += '<td class="submit-btn" colspan="3">';
    tpls_submit_btn += '<a onclick="selectAareaSub()">筛选</a>';
    tpls_submit_btn += '</td>';
    tpls_submit_btn += '</tr>';


    function seteasyTpl(arr_res) {

        if (!publicIsType('array', arr_res)) {
            return '';
        }

        var temp_i = 0,
            temp_j = 0,
            list_len = arr_res.length,
            item_len = 0,
            temp,
            m_tpls = '';


        m_tpls += '<tr>';
        m_tpls += '<td class="PlibSereachBox" style="background-color:#fff;padding:0;" colspan="3">';
        m_tpls += '<div class="upmuneBtnBox">';
        m_tpls += '<div class="upmuneBtn">';
        m_tpls += '<div class="upmunewp">';
        m_tpls += '<ul class="clearfix">';


        for (; temp_i < list_len; temp_i++) {
            m_tpls += '<li><a class="btnHd" onclick="showselectOption(event)">' + arr_res[temp_i].name + '<i class="cio"></i></a></li>';
        }

        m_tpls += '</ul>';
        m_tpls += '</div>';
        m_tpls += '</div>';
        m_tpls += '<div class="showAndSelect">';
        m_tpls += '<div class="rightPane">';
        /*m_tpls += '<a class="btns" onclick="multyChoose(this)">筛选</a>';
    m_tpls += '<a class="btns" onclick="showLeftMune(0);">已选产品</a>';*/
        m_tpls += '</div>';
        m_tpls += '<div class="showOpt">';

        temp_i = 0;

        for (; temp_i < list_len; temp_i++) {
            temp = arr_res[temp_i].values;
            item_len = temp.length;

            temp_j = 0;
            m_tpls += '<div class="optlistBox">';
            m_tpls += '<div class="opt-box">';
            for (; temp_j < item_len; temp_j++) {
                m_tpls += '<label class="option-l"><span onclick="screen_single(event)" title="' + temp[temp_j] + '" ><i class="ico"></i>' + temp[temp_j] + '</span></label>';
            }
            m_tpls += '</div> ';
            m_tpls += '<div class="multyBtnBox"><span class="btn-true" onclick="multyChoose(this)">确定</span><span class="btn-fasle" onclick="SelectMultyHideFn(this)">取消</span></div>';
            m_tpls += '</div>';

        }

        m_tpls += '</div>';
        m_tpls += '</div>';
        m_tpls += '</td>';
        m_tpls += '</tr>';

        return m_tpls;
    }

    function setArrInd(arr_name, arr) {

        var len = arr.length,
            i = 0,
            pre = [],
            next = [],
            indName = publicRegxMethod.formatIndSrt(arr_name),
            temp;

        for (; i < len; i++) {

            temp = ';' + (arr[i].name) + ';';

            if (indName.indexOf(temp) !== -1) {
                pre[pre.length] = arr[i];
            }
            else {
                next[next.length] = arr[i];
            }

        }

        return pre.concat(next);

    }


    function getArr(arr_name, ori_arr, spa_name) {

        if (!publicIsType('array', arr_name) || !publicIsType('array', ori_arr) || arr_name.length === 0 || ori_arr.length === 0) {
            return [];
        }

        if (spa_name) {
            if (!publicIsType('array', spa_name)) {
                return [];
            }
        }

        var formatArr = publicRegxMethod.formatIndSrt,
            arr_k_str = formatArr(arr_name),
            arr_sk_srr = formatArr(spa_name),
            arr_k = [],
            arr_sk = [],
            len = ori_arr.length,
            i = 0,
            temp_name;

        for (; i < len; i++) {

            temp_name = ';' + ori_arr[i].name + ';';
            if (arr_k_str.indexOf(temp_name) !== -1) {

                if (arr_sk_srr && arr_sk_srr.indexOf(temp_name)) {
                    arr_sk[arr_sk.length] = ori_arr[i];
                }
                else {
                    arr_k[arr_k.length] = ori_arr[i];
                }

            }

        }

        return arr_sk.concat(arr_k);

    }


    function selectAreaBoxForm(data_obj) {

        var res = data_obj,
            tpls = '',
            list_len = res.length,
            val,
            val_len,
            temp,
            temp2,
            temp_i = 0,
            temp_k,
            material_arr,
            temp_k = 0,
            choseArr;

        if (is_topLevel === 'yes') {

            //selectArea_randle({boxId:$slectAreaBox_sl,insetText:['size','cost','material[0]','prodName','submintBtn'],otherEl:[material_arr]});

            choseArr = getArr(['材质', '颜色'], data_obj);

            material_arr = seteasyTpl(choseArr);

            selectArea_randle({
                boxId: $slectAreaBox_sl,
                insetText: ['prodName', 'size', 'cost', 'factory', 'other'],
                otherEl: [material_arr]
            });
            is_topLevel = 'no';
        }
        else {

            choseArr = setArrInd(['材质', '颜色'], data_obj);

            tpls = seteasyTpl(choseArr);

            //selectArea_randle({boxId:$slectAreaBox_sl,insetText:['size','cost','other','prodName','submintBtn'],otherEl:[tpls]});
            selectArea_randle({
                boxId: $slectAreaBox_sl,
                insetText: ['prodName', 'size', 'cost', 'factory', 'other'],
                otherEl: [tpls]
            });
            is_topLevel = 'no';
        }

        /* 以图搜图 */
        var $select_imgBox = $('#select_imgBox'),
            $select_imgPane = $('#select_imgPane'),
            $select_showName = $select_imgPane.find('.imgfileBox span'),
            $sereachImg_inp = $select_imgPane.find('input');

        $select_imgBox.on('click', function (e) {
            var e = e || window.event;
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            else {
                e.cancelBubble = true;
            }
            select_imgPaneShow();
        });

        $select_imgPane.on('click', function (e) {
            var e = e || window.event;
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            else {
                e.cancelBubble = true;
            }
        });
        //搜索按钮
        /* $select_imgPane.find('.btnBox a').on('click',function(e){
        var e = e || window.event,
            imgName = '';
        if(e.stopPropagation){
            e.stopPropagation();
        }
        else{
            e.cancelBubble = true;
        }
        imgName = $sereachImg_inp.val();
        if(!imgName){
            alert('请上传图片');
            return;
        }
        imgName = publicRegxMethod.getFileName(imgName);
        //window.open('@{/jsp/offerlist/sereachByImg.jsp?'+imgName);

    }); */

        $(document).on('click', function (e) {
            var e = e || window.event;
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            else {
                e.cancelBubble = true;
            }
            select_imgPaneHide();
        });

        /* $sereachImg_inp.on('change',function(){
        var val = $(this).val();
        $select_showName.html(val);
    }); */


        function select_imgPaneShow() {
            $select_imgPane.slideToggle();
        }

        function select_imgPaneHide() {
            $select_imgPane.slideUp();
        }

        /* 以图搜图  end*/

        /* selectArea_randle({boxId:$slectAreaBox_sl,insetText:['size','cost','other','prodName','submintBtn'],otherEl:[tpls]}); */

    }


    function sereachImgChange(el_js) {
        var val = $(el_js).val();
        if (!val) {
            val = '点击上传本地图片';
        }

        $('#select_imgPane .imgfileBox span').html(val);

        setImagePreview(el_js, showSereachImg, preViweImg);
    }


    function selectAareaSub() {
        //改成
        var val = getSelectAllVal_xl();
        //var val = getSelectAllVal();

        if (val.val.length || val.xilie.length) {
            doSubmit(val);
        }
        else {
            doSubmit();
        }
    }


    function multyChoose() {

        var val = [];
        //改成
        val = getSelectAllVal_xl();
        //val = getSelectAllVal();

        /* if(!val.length){
        return;
    } */
        doSubmit(val);
        //SelectMultyHideFn(obj_js);
    }

    function getSelectAllVal_xl(isGetInd) {

        var $valWrap = $filterlistBox.find('.item'),
            returnV = {},
            $valEl,
            $_el,
            temp_len,
            temp_el,
            temp = '',
            val = [],
            indArr = [],
            indArr_ind,
            name,
            len = $valWrap.length;

        for (; len--;) {

            $_el = $valWrap.eq(len);
            name = $_el.find('.til').html();

            if(name === '厂商：' && !isGetInd){
                continue;
            }

            temp_el = $_el.find('.cke-js');
            temp_len = temp_el.length;
            if (temp_len <= 0) {
                continue;
            }

            temp = '';
            indArr_ind = indArr.length;

            indArr[indArr_ind] = {};
            indArr[indArr_ind]['key'] = len;
            indArr[indArr_ind]['val'] = [];

            for (; temp_len--;) {

                if(temp_el.eq(temp_len).is(':checked')){
                    temp += ';' + temp_el.eq(temp_len).data('value');
                    indArr[indArr_ind]['val'].push(temp_len);
                }

            }
            temp = temp.substr(1);

            if(!temp){
                continue;
            }

            if (name == '系列：') {
                returnV['xixie'] = temp.split(';');
            }
            else {
                val[val.length] = temp;
            }

        }

        if (isGetInd) {
            return indArr;
        }
        else {
            returnV['val'] = val;
            return returnV;
        }

    }

    function getSelectAllVal(isGetInd) {

        var $valWrap = $filterlist.find('.fitem'),
            returnV = {},
            $valEl,
            $_el,
            temp_len,
            temp_el,
            temp = '',
            val = [],
            indArr = [],
            indArr_ind,
            name,
            len = $valWrap.length;

        for (; len--;) {

            $_el = $valWrap.eq(len);
            name = $_el.find('.til').html();

            temp_el = $_el.find('.on-sel');
            temp_len = temp_el.length;
            if (temp_len <= 0) {
                continue;
            }

            temp = '';
            indArr_ind = indArr.length;

            indArr[indArr_ind] = {};
            indArr[indArr_ind]['key'] = len;
            indArr[indArr_ind]['val'] = [];

            for (; temp_len--;) {
                temp += ';' + temp_el.eq(temp_len).find('span').data('value');
                indArr[indArr_ind]['val'].push(temp_el.eq(temp_len).index());
            }
            temp = temp.substr(1);


            if (name == '系列：') {
                returnV['xixie'] = temp.split(';');
            }
            else {
                val[val.length] = temp;
            }

        }

        if (isGetInd) {
            return indArr;
        }
        else {
            returnV['val'] = val;
            return returnV;
        }

    }


    function multyRemoveSleFn(e) {
        var ent = e || window.event,
            obj_js = ent.currentTarget || e.srcElement,
            $self = $(obj_js),
            $valueWrap = $self.parents('.valueWrap'),
            len;

        if (ent.stopPropagation) {
            ent.stopPropagation();
        }
        else {
            ent.cancelable = true;
        }

        $self.parents('.option-l').removeClass('on-sel');

        len = $valueWrap.find('.on-sel').length;

        if (len == 0) {
            $valueWrap.removeClass('multy-select');
        }
    }


    var $selectAreaBox = $('#selectAreaBox');

    function SelectMultyHideFn(obj_js) {
        var $self = $(obj_js),
            ind = $self.parents('.optlistBox').index();

        SelectShowToggleFn(ind);
    }

    function SelectShowToggleFn(ind) {
        var $nav_li = $('.selectAreaBox .upmunewp a'),
            $pot_pane = $('.selectAreaBox .showOpt .optlistBox');

        $nav_li.eq(ind).removeClass('active');

        $pot_pane.eq(ind).slideUp();

        setTimeout('resetIfrHei()', 400);
    }

    function SelectHideMoreFn(obj_jq) {

        var $self = obj_jq,
            $opt_box = $self.parent().prev('.opt-box'),
            $valueWrap = $self.parents('.valueWrap');

        $opt_box.scrollTop(0);
        $valueWrap.removeClass('valBox-open');

    }

    function selectArea_randle(opt) {

        if (!publicIsType('object', opt)) {
            opt = {};
        }

        var opts = {
                boxId: '',
                insetText: 'all',
                otherEl: '',
            },
            $dynamicSearchBox,
            type = false,
            tpls = '',
            temp,
            temp_i = 0,
            temp_len,
            joinTpl,
            dealwithOther,
            dealwithMaterial,
            init;

        init = function () {
            _selfMagerParm(opts, opt);

            if (publicIsType('object', opts.boxId)) {
                $dynamicSearchBox = opts.boxId;
            }
            else if (publicIsType('string', opts.boxId)) {
                opts.boxId = publicRegxMethod.contOneSpace(opts.boxId);
                temp = opts.boxId.split(' ');

                if (temp.length > 1) {
                    $dynamicSearchBox = $(opts.boxId);
                }
                else {
                    $dynamicSearchBox = $('#' + opts.boxId);
                }
            }
        };

        dealwithMaterial = function (str) {
            var ind,
                i = 0,
                tpls_material_temp = '',
                temp,
                isMore = '',
                len;

            if (str.indexOf('[') !== -1) {
                if (!publicIsType('array', opts.otherEl)) {
                    return;
                }
                ind = str.split('[')[1].split(']')[0];
                if (!opts.otherEl[ind] || !publicIsType('array', opts.otherEl[ind])) {
                    return;
                }

                len = opts.otherEl[ind].length;
                temp = opts.otherEl[ind];

                if (len > MaxColNum_sl) {
                    isMore = tpls_material_more;
                }

                for (; i < len; i++) {
                    /* tpls_material_temp += '<label class="option-l" onclick="screen_single(event)"><span>'+temp[i]+'<i class="clo" onclick="multyRemoveSleFn(event)"></i></span></label>'; */
                    /* tpls_material_temp += '<label class="option-l" onclick="screen_single(event)"><span>'+temp[i]+'<i class="clo"></i></span></label>'; */
                    tpls_material_temp += '<label class="option-l"><span onclick="screen_single(event)">' + temp[i] + '<i class="clo"></i></span></label>';
                }

            }

            tpls += tpls_material_strat + tpls_material_temp + tpls_material_btn + isMore + tpls_material_end;
        };

        dealwithOther = function (str) {

            if (str.indexOf('material[') !== -1) {
                dealwithMaterial(str);
                return;
            }

            var ind;

            if (str.indexOf('other') === -1) {
                return;
            }

            if (str.indexOf('[') !== -1) {
                if (!publicIsType('array', opts.otherEl)) {
                    return;
                }
                ind = str.split('[')[1].split(']')[0];
                if (!opts.otherEl[ind]) {
                    return;
                }
                tpls += opts.otherEl[ind];
            }
            else {
                tpls += opts.otherEl[0];
            }
        };

        joinTpl = function (type) {

            switch (type) {
                case 'size' :
                    tpls += tpls_size;
                    break;
                case 'cost' :
                    tpls += tpls_cost;
                    break;
                case 'prodName' :
                    tpls += tpls_prodName;
                    break;
                case 'submintBtn' :
                    tpls += tpls_submit_btn;
                    break;
                case 'factory' :
                    tpls += tpls_factory;
                    break;
                default :
                    dealwithOther(type);
                    break;
            }

        };

        init();

        if (opts.insetText !== 'all') {
            if (!publicIsType('array', opts.insetText)) {
                return;
            }
        }

        if (opts.insetText === 'all') {
            tpls += tpls_size + tpls_cost + tpls_material + tpls_prodName;
        }
        else {
            temp_len = opts.insetText.length;

            for (; temp_i < temp_len; temp_i++) {
                joinTpl(opts.insetText[temp_i]);
            }
        }

        $dynamicSearchBox.html('');
        $dynamicSearchBox.append(tpls);

    }


    /* 动态筛选 end*/

    var $topWindow = $(window.top.document),
        homeWindowHei = $(window.top.window).height(),
        $modal_dialog = $topWindow.find('.modal-dialog'),
        thisPopMinheight = 951;


    function resetIfrHei() {
        var bodyHei,
            ajust = 300;

        if (window.parent.document.getElementById('myModal').className.indexOf(' in') === -1) {
            bodyHei = $(document.getElementsByClassName('prodLibheiBox')[0]).height() - 200;

            if (thisPopMinheight > bodyHei) {
                bodyHei = thisPopMinheight;
            }

            window.parent.document.getElementById('content_prodlib').height = bodyHei;
        }
        else {


            bodyHei = $(document.getElementsByClassName('prodLibheiBox')[0]).height();

            if (thisPopMinheight >= bodyHei) {
                bodyHei = thisPopMinheight;
            }

            window.top.document.getElementById('content_prodlib').height = bodyHei;
        }

        if (homeWindowHei <= (bodyHei + 150)) {
            $modal_dialog.addClass('sm');
        }
        else {
            $modal_dialog.removeClass('sm');
        }

    }

    //筛选区域下拉效果
    var showSelectOptListWp_ind;

    function showselectOption(e) {
        var ent = e || window.event,
            obj_js = ent.currentTarget || e.srcElement,
            self = $(obj_js),
            wpind = self.parents('li').index(),
            $showSelectOptBtn = $('.upmuneBtn .btnHd'),
            $showSelectOptListWp = $('.optlistBox');

        if (ent.stopPropagation) {
            ent.stopPropagation();
        }
        else {
            ent.cancelable = true;
        }

        if (self.hasClass('active')) {

            self.removeClass('active');

            $showSelectOptListWp.eq(showSelectOptListWp_ind).slideUp();

        }
        else {

            showSelectOptListWp_ind = wpind;

            $showSelectOptBtn.removeClass('active');
            self.addClass('active');

            $showSelectOptListWp.hide();

            $showSelectOptListWp.eq(wpind).slideDown('fast');

        }

        setTimeout('resetIfrHei()', 200);

    }

    function screen_single(e) {

        var ent = e || window.event,
            obj_js = ent.currentTarget || e.srcElement,
            $self = $(obj_js),
            $parent = $self.parents('.option-l');

        if (ent.stopPropagation) {
            ent.stopPropagation();
        }
        else {
            ent.cancelable = true;
        }

        if ($parent.hasClass('on-sel')) {
            $parent.removeClass('on-sel');
        }
        else {
            $parent.addClass('on-sel');
        }

    }


    //获取系列
    var $filterSeries = $('#filterSeries');
    var factorySelOldVal = '';

    //customProdType/{customTypeId}/Series

    function getSeriesFn(self){

        var $checkEl = $(self).find('.cke-js'),
            len = $checkEl.length,
			str = '',
            val,
            arr = [],
            i = 0;
        for(;i<len;i++){
			if($checkEl.eq(i).is(':checked')){
                val = $checkEl.eq(i).data('value')
                str += '"'+val+'"'+',';
                arr.push(val);
            }
        }

        if(!str){
            randerSeriesFn(null);
            return;
        }

        str = str.slice(0,-1);

        /*if(str === factorySelOldVal){
            return;
        }*/

        factorySelOldVal = str;

        $.ajax({
            url : projPath+'/customProdType/series',
            method : 'POST',
            data : JSON.stringify({factoryCompanyIds:arr,customTypeId:$("#prodTypeId").val()}),
            contentType: "application/json; charset=utf-8",
            success : function(r){
                if(r.data){
                    randerSeriesFn(r.data);
                }
                else{
                    randerSeriesFn(null);
                    alert('加载数据异常');
                }

            },
            error : function () {
                randerSeriesFn(null);
                alert('加载系列失败');
            }
        });

    }

    function randerSeriesFn(data){

        var temp,
            len = 0,
            i = 0,
            selText = '请选择',
            isDisabel = 'true',
            tpl = '';

        if(!data){
            selText = '请先选择厂商';
        }
        else{
            len = data.length;
            isDisabel = 'false';
        }

        tpl += '<form>';
        tpl += '<span class="til">系列：</span>';
        tpl += '<div class="optSel">';
        tpl += '<p class="showSelText" data-isdisable="'+isDisabel+'"  onclick="showChooseValFn(this)">'+selText+'</p>';
        tpl += '<i class="ico"></i>';
        tpl += '<div class="hideValBox" onmouseleave="hideChooseValFn(event)">';
        tpl += '<ul>';


        for(;i<len;i++){

            tpl += '<li>';
            tpl += '<label>';
            tpl += '<input type="checkbox" class="cke-js" data-value="' + data[i].value + '" onchange="showChooseVal(this)" value="'+data[i].name+'" />';
            tpl += '<span class="checkV">'+data[i].name+'</span>';
            tpl += '</label>';
            tpl += '</li>';

        }

        tpl += '</ul>';
        tpl += '</div>';
        tpl += '</div>';
        tpl += '</form>';

        $('#filterSeries').html(tpl);

    }


    //获取厂商

    var factoryNameTpl = '';

    getfactoryTpl();

    function getfactoryTpl(typeId,cb){

        var url = projPath + '/company/firm/all';

        if(typeId){
            url = projPath + '/company/firm/'+typeId;
        }

        $.ajax({
            url: url,
            success: function (r) {

                if (r.meta && r.meta.code !== 200) {
                    alert(r.meta.msg);
                    return;
                }

                var factory_tpl = '',
                    factory_len = r.data.length,
                    factory_i = 0;

                //factory_tpl += '<option value="">请选择</option>';

                var tpl = '';
                tpl += '<div class="item" id="filterFactory">';
                tpl += '<form>';
                tpl += '<span class="til">厂商：</span>';
                tpl += '<div class="optSel">';
                tpl += '<p class="showSelText" onclick="showChooseValFn(this)">请选择</p>';
                tpl += '<i class="ico"></i>';
                tpl += '<div class="hideValBox" onmouseleave="hideChooseValFn(event);getSeriesFn(this)">';
                tpl += '<ul>';

                for (; factory_i < factory_len; factory_i++) {
                    tpl += '<li>';
                    tpl += '<label>';
                    tpl += '<input type="checkbox" class="cke-js" data-value="' + r.data[factory_i].id + '" onchange="showChooseVal(this)" value="'+r.data[factory_i].name+'" />';
                    tpl += '<span class="checkV">'+r.data[factory_i].name+'</span>';
                    tpl += '</label>';
                    tpl += '</li>';
                }

                tpl += '</ul>';
                tpl += '</div>';
                tpl += '</div>';
                tpl += '</form>';
                tpl += '</div>';

                tpl += '<div class="item" id="filterSeries">';
                tpl += '<form>';
                tpl += '<span class="til">系列：</span>';
                tpl += '<div class="optSel">';
                tpl += '<p class="showSelText" data-isdisable="true"  onclick="showChooseValFn(this)">请先选择厂商</p>';
                tpl += '<i class="ico"></i>';
                tpl += '<div class="hideValBox" onmouseleave="hideChooseValFn(event)">';
                tpl += '<ul></ul>';
                tpl += '</div>';
                tpl += '</div>';
                tpl += '</form>';
                tpl += '</div>';

                factoryNameTpl = tpl;

                /*for (; factory_i < factory_len; factory_i++) {
                    factory_tpl += '<option value="' + r.data[factory_i].id + '">' + r.data[factory_i].name + '</option>';
                }

                $('#factoryName').html(factory_tpl);*/

                getFilterOpt('all');

            },
            error: function () {
                alert('加载厂商失败');
            },
            complete:function () {
                if(typeof cb === 'function'){
                    cb();
                }
            }
        });
    }





    /*多项筛选改成下拉框的形式*/
    function hideChooseValFn(e){
        var ev = e,
            el;

        if(ev.stopPropagation){
            ev.stopPropagation();
            el = ev.currentTarget;
        }
        else{
            ev.cancelBubble = true;
            el = ev.srcElement;
        }

        $(el).hide();

    }


    function showChooseValFn(self){

        var $el = $(self).siblings('.hideValBox'),
            isDisabel = $(self).data('isdisable');

        if(isDisabel){
            return;
        }

        $el.show();
    }


    function showChooseVal(self){

        var $parent = $(self).parents('.hideValBox'),
            $boxEl =  $parent.find('.cke-js'),
            $text = $parent.siblings('.showSelText'),
            len = $boxEl.length,
            str = '',
            i = 0;

        for(;i<len;i++){

            if($boxEl.eq(i).is(':checked')){
                str += $boxEl.eq(i).val()+' ';
            }

        }


        if(str === ''){
            str = '请选择';
        }
        else{
            str = str.slice(0, -1);
        }

        $text.html(str);

    }
    /*多项筛选改成下拉框的形式 end*/

</script>
</body>
</html>